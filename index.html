<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack Pro - Il tuo tracker fitness definitivo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #1e293b 75%, #0f172a 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            overscroll-behavior: none;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .smooth-transition {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        .btn-fast {
            transition: all 0.1s ease;
            cursor: pointer;
            user-select: none;
        }

        .btn-fast:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-fast:active {
            transform: translateY(0);
            transition: all 0.05s ease;
        }

        .delete-btn {
            min-width: 44px;
            min-height: 44px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-hover {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            will-change: transform;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.25);
        }

        .text-gradient {
            background: linear-gradient(135deg, #60a5fa 0%, #a855f7 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            animation: progressShimmer 3s ease-in-out infinite;
        }

        @keyframes progressShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .view {
            display: none;
            animation: fadeIn 0.25s ease-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            position: relative;
            height: 300px;
            contain: layout;
        }

        @media (max-width: 768px) {
            .nav-text {
                display: none;
            }
            .delete-btn {
                min-width: 48px;
                min-height: 48px;
                padding: 14px;
            }
        }

        /* Optimized scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            border-radius: 10px;
        }

        /* Input improvements */
        input:focus,
        select:focus,
        button:focus {
            outline: none;
            ring-offset: 0;
        }

        .input-enhanced {
            transition: all 0.15s ease;
            position: relative;
        }

        .input-enhanced:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Button pulse effect */
        .btn-pulse:hover {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Loading states */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Improved modal */
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.6);
        }

        /* Category colors */
        .category-petto { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .category-schiena { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .category-gambe { background: linear-gradient(135deg, #10b981, #059669); }
        .category-spalle { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .category-bicipiti { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .category-tricipiti { background: linear-gradient(135deg, #ec4899, #db2777); }
        .category-addominali { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .category-cardio { background: linear-gradient(135deg, #f97316, #ea580c); }

        /* Enhanced stats cards */
        .stats-card {
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .stats-card:hover::before {
            left: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-blue-900 to-purple-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="mb-8">
                <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center shadow-2xl">
                    <div class="text-3xl">💪</div>
                </div>
                <h1 class="text-4xl font-bold text-gradient mb-4">FitTrack Pro</h1>
                <div class="loading-spinner mx-auto"></div>
                <p class="text-gray-300 text-sm mt-4">Caricamento in corso...</p>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-effect text-white p-4 border-b border-slate-700/50 backdrop-blur-lg shadow-2xl sticky top-0 z-40">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-xl">
                        <div class="text-2xl">💪</div>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gradient">FitTrack Pro</h1>
                        <p class="text-gray-400 text-xs font-medium">Il tuo tracker fitness definitivo</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="importBtn" class="flex items-center space-x-2 px-3 py-2 text-sm bg-transparent border border-green-500 text-green-400 hover:bg-green-500 hover:text-white rounded-xl btn-fast">
                        <div class="text-lg">📥</div>
                        <span class="hidden sm:inline">Importa</span>
                    </button>
                    <button id="exportBtn" class="flex items-center space-x-2 px-3 py-2 text-sm bg-transparent border border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white rounded-xl btn-fast">
                        <div class="text-lg">📤</div>
                        <span class="hidden sm:inline">Esporta</span>
                    </button>
                    <button id="resetBtn" class="flex items-center space-x-2 px-3 py-2 text-sm bg-transparent border border-red-500 text-red-400 hover:bg-red-500 hover:text-white rounded-xl btn-fast">
                        <div class="text-lg">🔄</div>
                        <span class="hidden sm:inline">Reset</span>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-center">
                <div class="flex space-x-1 glass-effect rounded-2xl p-2 border border-slate-700/30">
                    <button data-view="dashboard" class="nav-btn flex items-center space-x-2 px-4 py-3 rounded-xl text-sm font-semibold btn-fast bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                        <div class="text-lg">🏠</div>
                        <span class="nav-text">Dashboard</span>
                    </button>
                    <button data-view="exercises" class="nav-btn flex items-center space-x-2 px-4 py-3 rounded-xl text-sm font-semibold btn-fast hover:bg-slate-700/50 text-gray-300 hover:text-white">
                        <div class="text-lg">💪</div>
                        <span class="nav-text">Esercizi</span>
                    </button>
                    <button data-view="progress" class="nav-btn flex items-center space-x-2 px-4 py-3 rounded-xl text-sm font-semibold btn-fast hover:bg-slate-700/50 text-gray-300 hover:text-white">
                        <div class="text-lg">📈</div>
                        <span class="nav-text">Progressi</span>
                    </button>
                    <button data-view="measurements" class="nav-btn flex items-center space-x-2 px-4 py-3 rounded-xl text-sm font-semibold btn-fast hover:bg-slate-700/50 text-gray-300 hover:text-white">
                        <div class="text-lg">📏</div>
                        <span class="nav-text">Misure</span>
                    </button>
                    <button data-view="goals" class="nav-btn flex items-center space-x-2 px-4 py-3 rounded-xl text-sm font-semibold btn-fast hover:bg-slate-700/50 text-gray-300 hover:text-white">
                        <div class="text-lg">🎯</div>
                        <span class="nav-text">Obiettivi</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="opacity-0 smooth-transition">
        
        <!-- Dashboard View -->
        <div id="dashboardView" class="view active p-4 md:p-6 space-y-6 max-w-7xl mx-auto">
            <div class="text-center space-y-2">
                <h2 class="text-4xl md:text-5xl font-bold text-gradient">Dashboard</h2>
                <p class="text-gray-400">Il tuo centro di controllo fitness 🏆</p>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="statsCards">
                <!-- Cards will be generated by JS -->
            </div>

            <!-- Quick Actions -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <div class="text-2xl mr-2">⚡</div>
                    Azioni Rapide
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button data-action="exercises" class="quick-action-btn flex flex-col items-center p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast btn-pulse">
                        <div class="text-3xl text-blue-400 mb-2">➕</div>
                        <span class="text-white text-sm font-medium">Nuovo Esercizio</span>
                    </button>
                    <button data-action="measurements" class="quick-action-btn flex flex-col items-center p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast btn-pulse">
                        <div class="text-3xl text-green-400 mb-2">📏</div>
                        <span class="text-white text-sm font-medium">Nuova Misura</span>
                    </button>
                    <button data-action="goals" class="quick-action-btn flex flex-col items-center p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast btn-pulse">
                        <div class="text-3xl text-purple-400 mb-2">🎯</div>
                        <span class="text-white text-sm font-medium">Nuovo Obiettivo</span>
                    </button>
                    <button data-action="export" class="quick-action-btn flex flex-col items-center p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast btn-pulse">
                        <div class="text-3xl text-yellow-400 mb-2">📤</div>
                        <span class="text-white text-sm font-medium">Esporta Dati</span>
                    </button>
                    <button data-action="reset" class="quick-action-btn flex flex-col items-center p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast btn-pulse">
                        <div class="text-3xl text-red-400 mb-2">🔄</div>
                        <span class="text-white text-sm font-medium">Reset App</span>
                    </button>
                </div>
            </div>

            <!-- Top Improvements -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <div class="text-2xl mr-2">🔥</div>
                        Miglioramenti (30gg)
                    </h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="topImprovements">
                    <!-- Content will be generated by JS -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <div class="text-2xl mr-2">⏰</div>
                    Attività Recente
                </h3>
                <div id="recentActivity" class="space-y-3">
                    <!-- Content will be generated by JS -->
                </div>
            </div>
        </div>

        <!-- Exercises View -->
        <div id="exercisesView" class="view p-4 md:p-6 space-y-6 max-w-7xl mx-auto">
            <div class="text-center space-y-2">
                <h2 class="text-4xl md:text-5xl font-bold text-gradient">Gestione Esercizi</h2>
                <p class="text-gray-400">Organizza e monitora i tuoi esercizi 💪</p>
            </div>
            
            <!-- Add Exercise Form -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-gradient-to-r from-green-600 to-green-700 rounded-xl mr-3 shadow-lg">
                        <div class="text-2xl">➕</div>
                    </div>
                    <h3 class="text-xl font-bold text-white">Nuovo Esercizio</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="exerciseName" placeholder="Nome esercizio" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-green-500 focus:outline-none smooth-transition placeholder-gray-400">
                    <select id="exerciseCategory" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-green-500 focus:outline-none smooth-transition">
                        <option value="petto">💪 Petto</option>
                        <option value="schiena">🔙 Schiena</option>
                        <option value="spalle">🏋️ Spalle</option>
                        <option value="bicipiti">💪 Bicipiti</option>
                        <option value="tricipiti">💪 Tricipiti</option>
                        <option value="gambe">🦵 Gambe</option>
                        <option value="addominali">🎯 Addominali</option>
                        <option value="cardio">❤️ Cardio</option>
                    </select>
                    <input type="text" id="exerciseMuscleGroup" placeholder="Gruppo muscolare" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-green-500 focus:outline-none smooth-transition placeholder-gray-400">
                </div>
                
                <button id="addExerciseBtn" class="flex items-center justify-center space-x-2 px-6 py-3 font-semibold rounded-xl btn-fast shadow-lg bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white btn-pulse">
                    <div class="text-lg">➕</div>
                    <span>Aggiungi Esercizio</span>
                </button>
            </div>

            <!-- Search and Filter -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-white font-semibold flex items-center">
                            <div class="text-lg mr-2">🔍</div>
                            Cerca Esercizi
                        </label>
                        <input type="text" id="searchExercises" placeholder="Cerca per nome..." class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition placeholder-gray-400 w-full">
                    </div>
                    <div class="space-y-2">
                        <label class="text-white font-semibold flex items-center">
                            <div class="text-lg mr-2">🏷️</div>
                            Filtra per Categoria
                        </label>
                        <select id="filterCategory" class="input-enhanced w-full glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition">
                            <option value="all">Tutti</option>
                            <option value="petto">💪 Petto</option>
                            <option value="schiena">🔙 Schiena</option>
                            <option value="spalle">🏋️ Spalle</option>
                            <option value="bicipiti">💪 Bicipiti</option>
                            <option value="tricipiti">💪 Tricipiti</option>
                            <option value="gambe">🦵 Gambe</option>
                            <option value="addominali">🎯 Addominali</option>
                            <option value="cardio">❤️ Cardio</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Exercises Grid -->
            <div id="exercisesGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Content will be generated by JS -->
            </div>
        </div>

        <!-- Progress View -->
        <div id="progressView" class="view p-4 md:p-6 space-y-6 max-w-7xl mx-auto">
            <div class="text-center space-y-2">
                <h2 class="text-4xl md:text-5xl font-bold text-gradient">Progressi</h2>
                <p class="text-gray-400">Visualizza i tuoi miglioramenti nel tempo 📈</p>
            </div>
            
            <!-- Exercise Progress Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-2xl p-6 card-hover">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                        <div class="text-xl mr-2">📊</div>
                        Progressione Peso Massimo
                    </h3>
                    <div class="chart-container">
                        <canvas id="weightProgressChart"></canvas>
                    </div>
                </div>
                
                <div class="glass-effect rounded-2xl p-6 card-hover">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                        <div class="text-xl mr-2">📈</div>
                        Volume di Allenamento
                    </h3>
                    <div class="chart-container">
                        <canvas id="volumeProgressChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Exercise Selection -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <div class="text-xl mr-2">🎯</div>
                    Analisi Dettagliata Esercizio
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select id="progressExerciseSelect" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition">
                        <option value="">Seleziona un esercizio...</option>
                    </select>
                    <select id="progressTimeRange" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition">
                        <option value="30">Ultimi 30 giorni</option>
                        <option value="60">Ultimi 60 giorni</option>
                        <option value="90">Ultimi 90 giorni</option>
                        <option value="all">Tutti i dati</option>
                    </select>
                </div>
                
                <div class="chart-container">
                    <canvas id="exerciseDetailChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Measurements View -->
        <div id="measurementsView" class="view p-4 md:p-6 space-y-6 max-w-7xl mx-auto">
            <div class="text-center space-y-2">
                <h2 class="text-4xl md:text-5xl font-bold text-gradient">Misure Corporee</h2>
                <p class="text-gray-400">Monitora i cambiamenti del tuo corpo 📏</p>
            </div>
            
            <!-- Add Measurement Form -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl mr-3 shadow-lg">
                        <div class="text-2xl">📏</div>
                    </div>
                    <h3 class="text-xl font-bold text-white">Nuova Misurazione</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <select id="measurementType" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-purple-500 focus:outline-none smooth-transition">
                        <option value="peso">⚖️ Peso (kg)</option>
                        <option value="altezza">📏 Altezza (cm)</option>
                        <option value="petto">💪 Petto (cm)</option>
                        <option value="vita">🎯 Vita (cm)</option>
                        <option value="fianchi">🍑 Fianchi (cm)</option>
                        <option value="braccio_dx">💪 Braccio Dx (cm)</option>
                        <option value="braccio_sx">💪 Braccio Sx (cm)</option>
                        <option value="coscia_dx">🦵 Coscia Dx (cm)</option>
                        <option value="coscia_sx">🦵 Coscia Sx (cm)</option>
                        <option value="bf_percentage">📊 Massa Grassa (%)</option>
                    </select>
                    <input type="number" id="measurementValue" placeholder="Valore" step="0.1" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-purple-500 focus:outline-none smooth-transition placeholder-gray-400">
                    <input type="date" id="measurementDate" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-purple-500 focus:outline-none smooth-transition">
                    <button id="addMeasurementBtn" class="flex items-center justify-center space-x-2 px-6 py-3 font-semibold rounded-xl btn-fast shadow-lg bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white btn-pulse">
                        <div class="text-lg">➕</div>
                        <span>Aggiungi</span>
                    </button>
                </div>
            </div>
            
            <!-- Measurements Chart -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <div class="text-xl mr-2">📈</div>
                    Andamento Misure
                </h3>
                <div class="mb-4">
                    <select id="measurementChartType" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-purple-500 focus:outline-none smooth-transition">
                        <option value="">Seleziona tipo di misurazione...</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="measurementChart"></canvas>
                </div>
            </div>
            
            <!-- Measurements List -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <div class="text-xl mr-2">📋</div>
                    Storico Misurazioni
                </h3>
                <div id="measurementsList" class="space-y-3">
                    <!-- Content will be generated by JS -->
                </div>
            </div>
        </div>

        <!-- Goals View -->
        <div id="goalsView" class="view p-4 md:p-6 space-y-6 max-w-7xl mx-auto">
            <div class="text-center space-y-2">
                <h2 class="text-4xl md:text-5xl font-bold text-gradient">Obiettivi</h2>
                <p class="text-gray-400">Definisci e raggiungi i tuoi traguardi 🎯</p>
            </div>
            
            <!-- Add Goal Form -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-gradient-to-r from-yellow-600 to-yellow-700 rounded-xl mr-3 shadow-lg">
                        <div class="text-2xl">🎯</div>
                    </div>
                    <h3 class="text-xl font-bold text-white">Nuovo Obiettivo</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="goalTarget" placeholder="Descrizione obiettivo (es. Panca Piana 100kg)" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-yellow-500 focus:outline-none smooth-transition placeholder-gray-400">
                    <select id="goalType" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-yellow-500 focus:outline-none smooth-transition">
                        <option value="weight">🏋️ Peso Esercizio</option>
                        <option value="reps">🔄 Ripetizioni</option>
                        <option value="body_weight">⚖️ Peso Corporeo</option>
                        <option value="body_measurement">📏 Misurazione Corpo</option>
                        <option value="time">⏱️ Tempo (min)</option>
                        <option value="distance">🏃 Distanza (km)</option>
                    </select>
                    <input type="number" id="goalValue" placeholder="Valore target" step="0.1" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-yellow-500 focus:outline-none smooth-transition placeholder-gray-400">
                    <input type="date" id="goalDeadline" class="input-enhanced glass-effect text-white p-3 rounded-xl border border-slate-600/50 focus:border-yellow-500 focus:outline-none smooth-transition">
                </div>
                
                <button id="addGoalBtn" class="flex items-center justify-center space-x-2 px-6 py-3 font-semibold rounded-xl btn-fast shadow-lg bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white btn-pulse">
                    <div class="text-lg">🎯</div>
                    <span>Aggiungi Obiettivo</span>
                </button>
            </div>
            
            <!-- Goals List -->
            <div id="goalsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Content will be generated by JS -->
            </div>
        </div>

    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 hidden">
        <div class="glass-effect rounded-2xl p-6 max-w-md w-full">
            <div class="text-center space-y-4">
                <div class="p-4 bg-red-500/20 rounded-full w-16 h-16 mx-auto flex items-center justify-center">
                    <div class="text-3xl">🗑️</div>
                </div>
                <div class="space-y-2">
                    <h3 class="text-xl font-bold text-white">Conferma Eliminazione</h3>
                    <p class="text-gray-300">Sei sicuro di voler eliminare questo elemento? Questa azione non può essere annullata.</p>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="cancelDeleteBtn" class="flex-1 px-4 py-3 font-semibold rounded-xl btn-fast bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white border border-gray-600">
                        ❌ Annulla
                    </button>
                    <button id="confirmDeleteBtn" class="flex-1 px-4 py-3 font-semibold rounded-xl btn-fast bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white shadow-lg">
                        🗑️ Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 hidden">
        <div class="glass-effect rounded-2xl p-6 max-w-md w-full">
            <div class="text-center space-y-4">
                <div class="p-4 bg-yellow-500/20 rounded-full w-16 h-16 mx-auto flex items-center justify-center">
                    <div class="text-3xl">⚠️</div>
                </div>
                <div class="space-y-2">
                    <h3 class="text-xl font-bold text-white">Reset Applicazione</h3>
                    <p class="text-gray-300">Sei sicuro di voler resettare completamente l'applicazione? Tutti i dati saranno eliminati definitivamente.</p>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button id="cancelResetBtn" class="flex-1 px-4 py-3 font-semibold rounded-xl btn-fast bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white border border-gray-600">
                        ❌ Annulla
                    </button>
                    <button id="confirmResetBtn" class="flex-1 px-4 py-3 font-semibold rounded-xl btn-fast bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white shadow-lg">
                        🔄 Reset Tutto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Import Input (hidden) -->
    <input type="file" id="fileImport" accept=".json" style="display: none;">

    <script>
        class FitTracker {
            constructor() {
                this.exercises = [];
                this.workouts = [];
                this.bodyMeasurements = [];
                this.goals = [];
                this.currentView = 'dashboard';
                this.deleteTarget = null;
                this.charts = {};
                this.debounceTimers = {};
                this.isLocalStorageAvailable = this.checkLocalStorageAvailability();
                
                this.init();
            }

            checkLocalStorageAvailability() {
                try {
                    const test = 'localStorage-test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch(e) {
                    console.warn('localStorage not available, using session storage');
                    return false;
                }
            }

            init() {
                try {
                    this.loadData();
                    this.setupEventListeners();
                    this.showApp();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.handleInitError();
                }
            }

            handleInitError() {
                // Show error and initialize with defaults
                this.initializeSampleData();
                this.showApp();
                this.showNotification('App inizializzata con dati di esempio', 'info');
            }

            showApp() {
                try {
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loadingScreen');
                        const mainContent = document.getElementById('mainContent');
                        
                        if (loadingScreen) {
                            loadingScreen.style.opacity = '0';
                            loadingScreen.style.transform = 'scale(0.8)';
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                                if (mainContent) {
                                    mainContent.style.opacity = '1';
                                    this.renderDashboard();
                                }
                            }, 300);
                        } else if (mainContent) {
                            // Fallback if loading screen doesn't exist
                            mainContent.style.opacity = '1';
                            this.renderDashboard();
                        }
                    }, 800); // Reduced from 200 to show loading longer
                } catch (error) {
                    console.error('ShowApp error:', error);
                    // Emergency fallback
                    document.getElementById('loadingScreen')?.remove();
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                        mainContent.style.opacity = '1';
                        this.renderDashboard();
                    }
                }
            }

            loadData() {
                try {
                    if (this.isLocalStorageAvailable) {
                        const savedExercises = localStorage.getItem('fittrack_exercises');
                        const savedWorkouts = localStorage.getItem('fittrack_workouts');
                        const savedMeasurements = localStorage.getItem('fittrack_measurements');
                        const savedGoals = localStorage.getItem('fittrack_goals');

                        if (savedExercises && savedWorkouts) {
                            this.exercises = JSON.parse(savedExercises) || [];
                            this.workouts = JSON.parse(savedWorkouts) || [];
                            this.bodyMeasurements = JSON.parse(savedMeasurements || '[]') || [];
                            this.goals = JSON.parse(savedGoals || '[]') || [];
                        } else {
                            this.initializeSampleData();
                        }
                    } else {
                        this.initializeSampleData();
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                    this.initializeSampleData();
                }
            }

            saveData() {
                try {
                    if (this.isLocalStorageAvailable) {
                        localStorage.setItem('fittrack_exercises', JSON.stringify(this.exercises));
                        localStorage.setItem('fittrack_workouts', JSON.stringify(this.workouts));
                        localStorage.setItem('fittrack_measurements', JSON.stringify(this.bodyMeasurements));
                        localStorage.setItem('fittrack_goals', JSON.stringify(this.goals));
                    }
                } catch (e) {
                    console.warn('Could not save to localStorage:', e);
                    this.showNotification('Attenzione: i dati non possono essere salvati permanentemente', 'error');
                }
            }

            initializeSampleData() {
                this.exercises = [
                    { id: 1, name: 'Panca Piana', category: 'petto', muscleGroup: 'Pettorale maggiore' },
                    { id: 2, name: 'Squat', category: 'gambe', muscleGroup: 'Quadricipiti' },
                    { id: 3, name: 'Deadlift', category: 'schiena', muscleGroup: 'Dorsali' },
                    { id: 4, name: 'Military Press', category: 'spalle', muscleGroup: 'Deltoidi' },
                    { id: 5, name: 'Curl Bilanciere', category: 'bicipiti', muscleGroup: 'Bicipiti' }
                ];

                this.workouts = [
                    { id: 1, exerciseId: 1, exercise: 'Panca Piana', weight: 80, sets: 3, reps: 8, date: '2025-08-15' },
                    { id: 2, exerciseId: 1, exercise: 'Panca Piana', weight: 82, sets: 3, reps: 8, date: '2025-08-18' },
                    { id: 3, exerciseId: 1, exercise: 'Panca Piana', weight: 85, sets: 3, reps: 7, date: '2025-08-22' },
                    { id: 4, exerciseId: 1, exercise: 'Panca Piana', weight: 87, sets: 3, reps: 7, date: '2025-08-25' },
                    { id: 5, exerciseId: 1, exercise: 'Panca Piana', weight: 90, sets: 3, reps: 6, date: '2025-08-27' },
                    { id: 6, exerciseId: 2, exercise: 'Squat', weight: 100, sets: 4, reps: 6, date: '2025-08-16' },
                    { id: 7, exerciseId: 2, exercise: 'Squat', weight: 105, sets: 4, reps: 6, date: '2025-08-20' },
                    { id: 8, exerciseId: 2, exercise: 'Squat', weight: 110, sets: 4, reps: 6, date: '2025-08-24' }
                ];

                this.bodyMeasurements = [
                    { id: 1, type: 'peso', value: 75, date: '2025-08-15' },
                    { id: 2, type: 'peso', value: 74.5, date: '2025-08-22' },
                    { id: 3, type: 'peso', value: 74, date: '2025-08-27' },
                    { id: 4, type: 'petto', value: 98, date: '2025-08-15' },
                    { id: 5, type: 'petto', value: 99, date: '2025-08-22' },
                    { id: 6, type: 'petto', value: 100, date: '2025-08-27' }
                ];

                this.goals = [
                    { id: 1, type: 'weight', target: 'Panca Piana 100kg', value: 100, current: 90, deadline: '2025-12-31' },
                    { id: 2, type: 'body_weight', target: 'Peso 70kg', value: 70, current: 74, deadline: '2025-11-30' },
                    { id: 3, type: 'weight', target: 'Squat 130kg', value: 130, current: 110, deadline: '2025-10-31' }
                ];

                this.saveData();
            }

            debounce(func, wait, key) {
                return (...args) => {
                    clearTimeout(this.debounceTimers[key]);
                    this.debounceTimers[key] = setTimeout(() => func.apply(this, args), wait);
                };
            }

            setupEventListeners() {
                try {
                    // Improved event delegation
                    document.addEventListener('click', this.handleClick.bind(this));
                    document.addEventListener('input', this.handleInput.bind(this));
                    document.addEventListener('change', this.handleChange.bind(this));

                    // Set default dates with error handling
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        const measurementDate = document.getElementById('measurementDate');
                        const goalDeadline = document.getElementById('goalDeadline');
                        if (measurementDate) measurementDate.value = today;
                        if (goalDeadline) goalDeadline.value = today;
                    } catch (dateError) {
                        console.warn('Date setting error:', dateError);
                    }
                } catch (error) {
                    console.error('Event listeners setup error:', error);
                }
            }

            handleClick(event) {
                try {
                    const target = event.target.closest('button') || event.target;
                    
                    // Add immediate visual feedback
                    if (target.tagName === 'BUTTON' || target.closest('button')) {
                        const btn = target.closest('button') || target;
                        btn.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            btn.style.transform = '';
                        }, 100);
                    }

                    // Handle button actions
                    if (target.classList?.contains('nav-btn') || target.dataset?.view) {
                        const view = target.dataset.view;
                        if (view) this.switchView(view);
                        return;
                    }

                    // Quick actions
                    if (target.dataset?.action) {
                        const action = target.dataset.action;
                        this.handleQuickAction(action);
                        return;
                    }

                    // Specific button handlers
                    this.handleSpecificButtons(target);
                } catch (error) {
                    console.error('Click handler error:', error);
                }
            }

            handleQuickAction(action) {
                try {
                    switch(action) {
                        case 'exercises':
                        case 'measurements':
                        case 'goals':
                            this.switchView(action);
                            break;
                        case 'export':
                            this.exportData();
                            break;
                        case 'reset':
                            this.showResetModal();
                            break;
                    }
                } catch (error) {
                    console.error('Quick action error:', error);
                }
            }

            handleSpecificButtons(target) {
                try {
                    const id = target.id;
                    const action = target.dataset?.btnAction;

                    switch(id) {
                        case 'addExerciseBtn':
                            this.addExercise();
                            break;
                        case 'addMeasurementBtn':
                            this.addMeasurement();
                            break;
                        case 'addGoalBtn':
                            this.addGoal();
                            break;
                        case 'exportBtn':
                            this.exportData();
                            break;
                        case 'importBtn':
                            const fileInput = document.getElementById('fileImport');
                            if (fileInput) fileInput.click();
                            break;
                        case 'resetBtn':
                            this.showResetModal();
                            break;
                        case 'cancelDeleteBtn':
                            this.hideModal('deleteModal');
                            break;
                        case 'confirmDeleteBtn':
                            this.confirmDelete();
                            break;
                        case 'cancelResetBtn':
                            this.hideModal('resetModal');
                            break;
                        case 'confirmResetBtn':
                            this.confirmReset();
                            break;
                    }

                    // Handle delete buttons
                    if (action === 'delete') {
                        const type = target.dataset.type;
                        const id = target.dataset.itemId;
                        this.showDeleteModal(type, id);
                    }

                    // Handle workout add buttons
                    if (action === 'add-workout') {
                        const exerciseId = parseInt(target.dataset.exerciseId);
                        this.addWorkout(exerciseId);
                    }
                } catch (error) {
                    console.error('Specific button handler error:', error);
                }
            }

            handleInput(event) {
                try {
                    const target = event.target;

                    // Debounced search
                    if (target.id === 'searchExercises') {
                        this.debounce(() => this.renderExercises(), 200, 'search')();
                    }
                } catch (error) {
                    console.error('Input handler error:', error);
                }
            }

            handleChange(event) {
                try {
                    const target = event.target;

                    switch(target.id) {
                        case 'fileImport':
                            this.importData(event);
                            break;
                        case 'filterCategory':
                            this.renderExercises();
                            break;
                        case 'progressExerciseSelect':
                        case 'progressTimeRange':
                            this.renderExerciseDetailChart();
                            break;
                        case 'measurementChartType':
                            this.renderMeasurementChart();
                            break;
                    }
                } catch (error) {
                    console.error('Change handler error:', error);
                }
            }

            hideModal(modalId) {
                try {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.classList.add('hidden');
                } catch (error) {
                    console.error('Hide modal error:', error);
                }
            }

            switchView(view) {
                try {
                    // Update navigation with error handling
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-lg');
                        btn.classList.add('hover:bg-slate-700/50', 'text-gray-300', 'hover:text-white');
                    });

                    const activeBtn = document.querySelector(`[data-view="${view}"]`);
                    if (activeBtn) {
                        activeBtn.classList.remove('hover:bg-slate-700/50', 'text-gray-300', 'hover:text-white');
                        activeBtn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-lg');
                    }

                    // Update content
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    const targetView = document.getElementById(view + 'View');
                    if (targetView) targetView.classList.add('active');

                    this.currentView = view;

                    // Render appropriate content with timeout for smooth transition
                    setTimeout(() => {
                        try {
                            switch(view) {
                                case 'dashboard':
                                    this.renderDashboard();
                                    break;
                                case 'exercises':
                                    this.renderExercises();
                                    break;
                                case 'progress':
                                    this.renderProgress();
                                    break;
                                case 'measurements':
                                    this.renderMeasurements();
                                    break;
                                case 'goals':
                                    this.renderGoals();
                                    break;
                            }
                        } catch (renderError) {
                            console.error('Render error for view:', view, renderError);
                        }
                    }, 50);
                } catch (error) {
                    console.error('Switch view error:', error);
                }
            }

            renderDashboard() {
                try {
                    this.renderStatsCards();
                    this.renderTopImprovements();
                    this.renderRecentActivity();
                } catch (error) {
                    console.error('Dashboard render error:', error);
                    this.showNotification('Errore nel caricamento della dashboard', 'error');
                }
            }

            renderStatsCards() {
                try {
                    const completedGoals = this.goals.filter(g => this.calculateGoalProgress(g) >= 100).length;
                    
                    const stats = [
                        { title: 'Esercizi Attivi', value: this.exercises.length, emoji: '💪', subtitle: 'Nel tuo repertorio', color: 'blue' },
                        { title: 'Obiettivi Raggiunti', value: completedGoals, emoji: '🏆', subtitle: 'Traguardi completati', color: 'yellow' },
                        { title: 'Misurazioni', value: this.bodyMeasurements.length, emoji: '📏', subtitle: 'Registrazioni corpo', color: 'purple' }
                    ];

                    const container = document.getElementById('statsCards');
                    if (container) {
                        container.innerHTML = stats.map((stat, index) => `
                            <div class="stats-card glass-effect rounded-2xl p-4 md:p-6 card-hover">
                                <div class="relative">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="text-4xl">${stat.emoji}</div>
                                        <div class="text-2xl opacity-20">${stat.emoji}</div>
                                    </div>
                                    <h3 class="text-gray-400 text-xs md:text-sm font-medium mb-1">${stat.title}</h3>
                                    <p class="text-2xl md:text-3xl font-bold text-white mb-1">${stat.value}</p>
                                    <p class="text-gray-500 text-xs">${stat.subtitle}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Stats cards render error:', error);
                }
            }

            renderTopImprovements() {
                try {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const improvements = this.exercises.map(exercise => {
                        try {
                            const exerciseWorkouts = this.workouts
                                .filter(w => w.exerciseId === exercise.id && new Date(w.date) >= thirtyDaysAgo)
                                .sort((a, b) => new Date(a.date) - new Date(b.date));
                                
                            if (exerciseWorkouts.length < 2) return null;
                            
                            const first = exerciseWorkouts[0];
                            const last = exerciseWorkouts[exerciseWorkouts.length - 1];
                            const improvement = last.weight - first.weight;
                            
                            return {
                                exercise: exercise.name,
                                improvement,
                                percentage: ((improvement / first.weight) * 100).toFixed(1),
                                from: first.weight,
                                to: last.weight
                            };
                        } catch (exerciseError) {
                            console.warn('Exercise improvement calculation error:', exerciseError);
                            return null;
                        }
                    })
                    .filter(item => item && item.improvement > 0)
                    .sort((a, b) => b.improvement - a.improvement)
                    .slice(0, 3);

                    const container = document.getElementById('topImprovements');
                    if (!container) return;

                    if (improvements.length === 0) {
                        container.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">📈 Nessun miglioramento negli ultimi 30 giorni</p>';
                        return;
                    }

                    const medals = ['🥇', '🥈', '🥉'];
                    container.innerHTML = improvements.map((improvement, index) => `
                        <div class="relative bg-gradient-to-br from-orange-900/20 to-red-900/10 p-4 rounded-xl border border-orange-500/20 hover:border-orange-500/40 smooth-transition overflow-hidden group card-hover">
                            <div class="absolute -top-8 -right-8 w-16 h-16 bg-gradient-to-br from-orange-500/20 to-red-500/20 rounded-full"></div>
                            <div class="absolute top-2 right-2 text-2xl">${medals[index]}</div>
                            <div class="space-y-2 relative z-10">
                                <h4 class="text-white font-bold flex items-center">
                                    <span class="text-xl mr-2">💪</span>
                                    ${improvement.exercise}
                                </h4>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Progresso:</span>
                                    <span class="text-orange-400 font-bold">+${improvement.improvement}kg</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Crescita:</span>
                                    <span class="text-green-400 font-bold">+${improvement.percentage}%</span>
                                </div>
                                <div class="pt-2 border-t border-gray-700">
                                    <div class="flex items-center justify-between text-xs text-gray-500">
                                        <span>📊 ${improvement.from}kg → ${improvement.to}kg</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Top improvements render error:', error);
                }
            }

            renderRecentActivity() {
                try {
                    const recentWorkouts = this.workouts
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 6);

                    const container = document.getElementById('recentActivity');
                    if (!container) return;

                    if (recentWorkouts.length === 0) {
                        container.innerHTML = '<p class="text-gray-400 text-center py-4">📭 Nessuna attività recente</p>';
                        return;
                    }

                    container.innerHTML = recentWorkouts.map(workout => `
                        <div class="flex items-center justify-between p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast card-hover">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">💪</div>
                                <div>
                                    <h4 class="text-white font-semibold">${workout.exercise}</h4>
                                    <p class="text-gray-400 text-sm">📊 ${workout.sets} serie × ${workout.reps} reps</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-blue-400 font-bold">⚖️ ${workout.weight}kg</p>
                                <p class="text-gray-500 text-sm">📅 ${this.formatDate(workout.date)}</p>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Recent activity render error:', error);
                }
            }

            renderExercises() {
                try {
                    const searchInput = document.getElementById('searchExercises');
                    const filterSelect = document.getElementById('filterCategory');
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                    const categoryFilter = filterSelect ? filterSelect.value : 'all';
                    
                    let filtered = [...this.exercises];
                    
                    if (categoryFilter !== 'all') {
                        filtered = filtered.filter(ex => ex.category === categoryFilter);
                    }
                    
                    if (searchTerm) {
                        filtered = filtered.filter(ex => 
                            ex.name.toLowerCase().includes(searchTerm) ||
                            (ex.muscleGroup && ex.muscleGroup.toLowerCase().includes(searchTerm))
                        );
                    }

                    const container = document.getElementById('exercisesGrid');
                    if (!container) return;
                    
                    if (filtered.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full glass-effect rounded-2xl p-8 card-hover text-center py-12">
                                <div class="space-y-4">
                                    <div class="text-6xl">🔍</div>
                                    <h3 class="text-xl font-semibold text-gray-300">Nessun esercizio trovato</h3>
                                    <p class="text-gray-500">
                                        ${searchTerm ? `Nessun risultato per "${searchTerm}"` : `Nessun esercizio nella categoria selezionata`}
                                    </p>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    const categoryEmojis = {
                        petto: '💪',
                        schiena: '🔙',
                        gambe: '🦵',
                        spalle: '🏋️',
                        bicipiti: '💪',
                        tricipiti: '💪',
                        addominali: '🎯',
                        cardio: '❤️'
                    };

                    container.innerHTML = filtered.map(exercise => {
                        try {
                            const exerciseWorkouts = this.workouts.filter(w => w.exerciseId === exercise.id);
                            const maxWeight = exerciseWorkouts.length > 0 ? Math.max(...exerciseWorkouts.map(w => w.weight || 0)) : 0;
                            const latestWorkout = exerciseWorkouts.length > 0 ? 
                                exerciseWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;

                            return `
                                <div class="glass-effect rounded-2xl p-6 card-hover relative group">
                                    <div class="absolute -top-2 -right-2 px-3 py-1 rounded-full text-xs font-bold shadow-lg category-${exercise.category} text-white">
                                        ${categoryEmojis[exercise.category] || '💪'} ${exercise.category}
                                    </div>

                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center">
                                            <div class="text-3xl mr-3">
                                                ${categoryEmojis[exercise.category] || '💪'}
                                            </div>
                                            <div>
                                                <h4 class="text-white font-bold text-lg">${exercise.name}</h4>
                                                <p class="text-gray-400 text-sm">${exercise.muscleGroup || 'Non specificato'}</p>
                                            </div>
                                        </div>
                                        
                                        <button class="delete-btn opacity-0 group-hover:opacity-100 smooth-transition font-semibold rounded-lg bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white shadow-lg btn-fast" data-btn-action="delete" data-type="exercise" data-item-id="${exercise.id}">
                                            <div class="text-lg">🗑️</div>
                                        </button>
                                    </div>
                                    
                                    <div class="space-y-3 mb-4">
                                        <div class="flex justify-between items-center p-3 glass-effect rounded-lg">
                                            <span class="text-gray-400 text-sm font-medium">💪 Peso Massimo</span>
                                            <span class="text-blue-400 font-bold text-lg">${maxWeight}kg</span>
                                        </div>
                                        ${latestWorkout ? `
                                            <div class="flex justify-between items-center p-3 glass-effect rounded-lg">
                                                <span class="text-gray-400 text-sm font-medium">📅 Ultimo Allenamento</span>
                                                <span class="text-green-400 font-semibold text-sm">${this.formatDate(latestWorkout.date)}</span>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <div class="border-t border-slate-700/50 pt-4">
                                        <h5 class="text-white font-semibold mb-3 flex items-center">
                                            <div class="text-lg mr-2">➕</div>
                                            Aggiungi Carico
                                        </h5>
                                        <div class="grid grid-cols-3 gap-2 mb-3">
                                            <input type="number" placeholder="Peso" class="input-enhanced glass-effect text-white p-2 text-sm rounded-lg border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition placeholder-gray-400" id="weight-${exercise.id}">
                                            <input type="number" placeholder="Serie" class="input-enhanced glass-effect text-white p-2 text-sm rounded-lg border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition placeholder-gray-400" id="sets-${exercise.id}">
                                            <input type="number" placeholder="Reps" class="input-enhanced glass-effect text-white p-2 text-sm rounded-lg border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition placeholder-gray-400" id="reps-${exercise.id}">
                                        </div>
                                        <input type="date" value="${new Date().toISOString().split('T')[0]}" class="input-enhanced glass-effect text-white p-2 text-sm rounded-lg border border-slate-600/50 focus:border-blue-500 focus:outline-none smooth-transition w-full mb-3" id="date-${exercise.id}">
                                        
                                        <button class="w-full flex items-center justify-center space-x-2 px-4 py-3 text-sm font-semibold rounded-lg btn-fast bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white shadow-lg btn-pulse" data-btn-action="add-workout" data-exercise-id="${exercise.id}">
                                            <div class="text-lg">✅</div>
                                            <span>Salva Carico</span>
                                        </button>
                                    </div>
                                </div>
                            `;
                        } catch (exerciseRenderError) {
                            console.warn('Exercise render error:', exerciseRenderError);
                            return '';
                        }
                    }).join('');
                } catch (error) {
                    console.error('Exercises render error:', error);
                }
            }

            renderProgress() {
                try {
                    if (typeof Chart !== 'undefined') {
                        setTimeout(() => {
                            this.renderProgressCharts();
                            this.populateProgressExerciseSelect();
                        }, 100);
                    } else {
                        console.warn('Chart.js not available');
                        this.showNotification('Grafici non disponibili - Chart.js non caricato', 'error');
                    }
                } catch (error) {
                    console.error('Progress render error:', error);
                }
            }

            renderProgressCharts() {
                try {
                    this.renderWeightProgressChart();
                    this.renderVolumeProgressChart();
                    this.renderExerciseDetailChart();
                } catch (error) {
                    console.error('Progress charts render error:', error);
                }
            }

            renderWeightProgressChart() {
                try {
                    const ctx = document.getElementById('weightProgressChart');
                    if (!ctx || typeof Chart === 'undefined') return;

                    if (this.charts.weightProgress) {
                        this.charts.weightProgress.destroy();
                    }

                    const exerciseMaxWeights = this.exercises.map(exercise => {
                        const exerciseWorkouts = this.workouts.filter(w => w.exerciseId === exercise.id);
                        const maxWeight = exerciseWorkouts.length > 0 ? Math.max(...exerciseWorkouts.map(w => w.weight || 0)) : 0;
                        return { name: exercise.name, weight: maxWeight };
                    }).filter(e => e.weight > 0);

                    if (exerciseMaxWeights.length === 0) {
                        ctx.parentElement.innerHTML = '<div class="text-center text-gray-400 p-8">📊 Nessun dato disponibile</div>';
                        return;
                    }

                    this.charts.weightProgress = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: exerciseMaxWeights.map(e => e.name),
                            datasets: [{
                                label: 'Peso Massimo (kg)',
                                data: exerciseMaxWeights.map(e => e.weight),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                borderRadius: 8,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 500,
                                easing: 'easeOutQuart'
                            },
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45 },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Weight progress chart error:', error);
                }
            }

            renderVolumeProgressChart() {
                try {
                    const ctx = document.getElementById('volumeProgressChart');
                    if (!ctx || typeof Chart === 'undefined') return;

                    if (this.charts.volumeProgress) {
                        this.charts.volumeProgress.destroy();
                    }

                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const volumeByDate = {};
                    this.workouts
                        .filter(w => new Date(w.date) >= thirtyDaysAgo)
                        .forEach(workout => {
                            const volume = (workout.weight || 0) * (workout.sets || 0) * (workout.reps || 0);
                            if (!volumeByDate[workout.date]) {
                                volumeByDate[workout.date] = 0;
                            }
                            volumeByDate[workout.date] += volume;
                        });

                    const dates = Object.keys(volumeByDate).sort();
                    const volumes = dates.map(date => volumeByDate[date]);

                    if (dates.length === 0) {
                        ctx.parentElement.innerHTML = '<div class="text-center text-gray-400 p-8">📈 Nessun dato disponibile</div>';
                        return;
                    }

                    this.charts.volumeProgress = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates.map(date => this.formatDate(date)),
                            datasets: [{
                                label: 'Volume Totale (kg)',
                                data: volumes,
                                borderColor: 'rgba(139, 92, 246, 1)',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 500,
                                easing: 'easeOutQuart'
                            },
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45 },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Volume progress chart error:', error);
                }
            }

            populateProgressExerciseSelect() {
                try {
                    const select = document.getElementById('progressExerciseSelect');
                    if (!select) return;
                    
                    const exercisesWithWorkouts = this.exercises.filter(e => 
                        this.workouts.some(w => w.exerciseId === e.id)
                    );

                    select.innerHTML = '<option value="">Seleziona un esercizio...</option>' +
                        exercisesWithWorkouts.map(e => 
                            `<option value="${e.id}">${e.name}</option>`
                        ).join('');
                } catch (error) {
                    console.error('Populate exercise select error:', error);
                }
            }

            renderExerciseDetailChart() {
                try {
                    const exerciseSelect = document.getElementById('progressExerciseSelect');
                    const timeRangeSelect = document.getElementById('progressTimeRange');
                    
                    const exerciseId = exerciseSelect ? exerciseSelect.value : '';
                    const timeRange = timeRangeSelect ? timeRangeSelect.value : '30';
                    
                    const ctx = document.getElementById('exerciseDetailChart');
                    if (!ctx) return;
                    
                    if (!exerciseId) {
                        if (this.charts.exerciseDetail) {
                            this.charts.exerciseDetail.destroy();
                            delete this.charts.exerciseDetail;
                        }
                        const context = ctx.getContext('2d');
                        if (context) {
                            context.clearRect(0, 0, ctx.width, ctx.height);
                        }
                        return;
                    }

                    if (this.charts.exerciseDetail) {
                        this.charts.exerciseDetail.destroy();
                    }

                    let filteredWorkouts = this.workouts.filter(w => w.exerciseId == exerciseId);
                    
                    if (timeRange !== 'all') {
                        const daysAgo = new Date();
                        daysAgo.setDate(daysAgo.getDate() - parseInt(timeRange));
                        filteredWorkouts = filteredWorkouts.filter(w => new Date(w.date) >= daysAgo);
                    }

                    filteredWorkouts.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const exercise = this.exercises.find(e => e.id == exerciseId);

                    this.charts.exerciseDetail = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: filteredWorkouts.map(w => this.formatDate(w.date)),
                            datasets: [{
                                label: 'Peso (kg)',
                                data: filteredWorkouts.map(w => w.weight),
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 500,
                                easing: 'easeOutQuart'
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: exercise ? `📈 Progressione - ${exercise.name}` : '📈 Progressione Esercizio',
                                    color: '#ffffff',
                                    font: { size: 16, weight: 'bold' }
                                },
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: { 
                                        color: '#94a3b8',
                                        callback: function(value) {
                                            return value + 'kg';
                                        }
                                    },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45 },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Exercise detail chart error:', error);
                }
            }

            renderMeasurements() {
                try {
                    this.renderMeasurementsList();
                    this.populateMeasurementChartTypes();
                } catch (error) {
                    console.error('Measurements render error:', error);
                }
            }

            populateMeasurementChartTypes() {
                try {
                    const select = document.getElementById('measurementChartType');
                    if (!select) return;
                    
                    const types = [...new Set(this.bodyMeasurements.map(m => m.type))];
                    
                    const typeLabels = {
                        peso: '⚖️ Peso (kg)',
                        altezza: '📏 Altezza (cm)',
                        petto: '💪 Petto (cm)',
                        vita: '🎯 Vita (cm)',
                        fianchi: '🍑 Fianchi (cm)',
                        braccio_dx: '💪 Braccio Dx (cm)',
                        braccio_sx: '💪 Braccio Sx (cm)',
                        coscia_dx: '🦵 Coscia Dx (cm)',
                        coscia_sx: '🦵 Coscia Sx (cm)',
                        bf_percentage: '📊 Massa Grassa (%)'
                    };

                    select.innerHTML = '<option value="">Seleziona tipo di misurazione...</option>' +
                        types.map(type => 
                            `<option value="${type}">${typeLabels[type] || type}</option>`
                        ).join('');
                } catch (error) {
                    console.error('Populate measurement chart types error:', error);
                }
            }

            renderMeasurementChart() {
                try {
                    const measurementTypeSelect = document.getElementById('measurementChartType');
                    const measurementType = measurementTypeSelect ? measurementTypeSelect.value : '';
                    
                    const ctx = document.getElementById('measurementChart');
                    if (!ctx || !measurementType) {
                        if (this.charts.measurement) {
                            this.charts.measurement.destroy();
                            delete this.charts.measurement;
                        }
                        return;
                    }

                    if (this.charts.measurement) {
                        this.charts.measurement.destroy();
                    }

                    const measurements = this.bodyMeasurements
                        .filter(m => m.type === measurementType)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));

                    const typeLabels = {
                        peso: '⚖️ Peso (kg)',
                        altezza: '📏 Altezza (cm)',
                        petto: '💪 Petto (cm)',
                        vita: '🎯 Vita (cm)',
                        fianchi: '🍑 Fianchi (cm)',
                        braccio_dx: '💪 Braccio Dx (cm)',
                        braccio_sx: '💪 Braccio Sx (cm)',
                        coscia_dx: '🦵 Coscia Dx (cm)',
                        coscia_sx: '🦵 Coscia Sx (cm)',
                        bf_percentage: '📊 Massa Grassa (%)'
                    };

                    this.charts.measurement = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: measurements.map(m => this.formatDate(m.date)),
                            datasets: [{
                                label: typeLabels[measurementType],
                                data: measurements.map(m => m.value),
                                borderColor: 'rgba(139, 92, 246, 1)',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 500,
                                easing: 'easeOutQuart'
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `📈 Andamento - ${typeLabels[measurementType]}`,
                                    color: '#ffffff',
                                    font: { size: 16, weight: 'bold' }
                                },
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: measurementType !== 'peso',
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', maxRotation: 45 },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Measurement chart error:', error);
                }
            }

            renderMeasurementsList() {
                try {
                    const container = document.getElementById('measurementsList');
                    if (!container) return;
                    
                    const sortedMeasurements = this.bodyMeasurements
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 15);

                    if (sortedMeasurements.length === 0) {
                        container.innerHTML = '<p class="text-gray-400 text-center py-8">📏 Nessuna misurazione registrata</p>';
                        return;
                    }

                    const typeLabels = {
                        peso: '⚖️ Peso',
                        altezza: '📏 Altezza', 
                        petto: '💪 Petto',
                        vita: '🎯 Vita',
                        fianchi: '🍑 Fianchi',
                        braccio_dx: '💪 Braccio Dx',
                        braccio_sx: '💪 Braccio Sx',
                        coscia_dx: '🦵 Coscia Dx',
                        coscia_sx: '🦵 Coscia Sx',
                        bf_percentage: '📊 Massa Grassa'
                    };

                    container.innerHTML = sortedMeasurements.map(measurement => `
                        <div class="flex items-center justify-between p-4 glass-effect rounded-xl hover:bg-slate-700/30 btn-fast card-hover">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">📏</div>
                                <div>
                                    <h4 class="text-white font-semibold">${typeLabels[measurement.type] || measurement.type}</h4>
                                    <p class="text-gray-400 text-sm">📅 ${this.formatDate(measurement.date)}</p>
                                </div>
                            </div>
                            <div class="text-right flex items-center space-x-2">
                                <p class="text-purple-400 font-bold">${measurement.value}${measurement.type === 'peso' ? 'kg' : measurement.type === 'bf_percentage' ? '%' : 'cm'}</p>
                                <button class="delete-btn text-red-400 hover:text-red-300 btn-fast" data-btn-action="delete" data-type="measurement" data-item-id="${measurement.id}">
                                    <div class="text-lg">🗑️</div>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Measurements list render error:', error);
                }
            }

            renderGoals() {
                try {
                    const container = document.getElementById('goalsList');
                    if (!container) return;
                    
                    if (this.goals.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full glass-effect rounded-2xl p-8 card-hover text-center py-12">
                                <div class="space-y-4">
                                    <div class="text-6xl">🎯</div>
                                    <h3 class="text-xl font-semibold text-gray-300">Nessun obiettivo definito</h3>
                                    <p class="text-gray-500">Inizia aggiungendo i tuoi primi traguardi!</p>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = this.goals.map(goal => {
                        try {
                            const progress = this.calculateGoalProgress(goal);
                            const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                            const isOverdue = daysLeft < 0;
                            const isCompleted = progress >= 100;

                            const typeEmojis = {
                                weight: '🏋️',
                                reps: '🔄',
                                body_weight: '⚖️',
                                body_measurement: '📏',
                                time: '⏱️',
                                distance: '🏃'
                            };

                            return `
                                <div class="glass-effect rounded-2xl p-6 card-hover relative overflow-hidden">
                                    ${isCompleted ? `
                                        <div class="absolute top-4 right-4 p-2 bg-green-500/20 rounded-full">
                                            <div class="text-2xl">✅</div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="text-3xl">${typeEmojis[goal.type] || '🎯'}</div>
                                            <div>
                                                <h4 class="text-white font-bold text-lg">${goal.target}</h4>
                                                <p class="text-gray-400 text-sm">
                                                    ${isOverdue ? '⏰ Scaduto' : isCompleted ? '🎉 Completato!' : `⏳ ${daysLeft} giorni rimasti`}
                                                </p>
                                            </div>
                                        </div>
                                        <button class="delete-btn text-red-400 hover:text-red-300 btn-fast" data-btn-action="delete" data-type="goal" data-item-id="${goal.id}">
                                            <div class="text-lg">🗑️</div>
                                        </button>
                                    </div>

                                    <div class="space-y-3 mb-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400 text-sm">📊 Progressi</span>
                                            <span class="text-white font-semibold">${progress.toFixed(1)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-3">
                                            <div class="${isCompleted ? 'bg-green-500' : 'progress-bar'} h-3 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                                        </div>
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-gray-500">📍 Attuale: ${goal.current || 0}</span>
                                            <span class="text-gray-500">🎯 Target: ${goal.value}</span>
                                        </div>
                                    </div>

                                    <div class="text-right">
                                        <p class="text-gray-400 text-sm">📅 Scadenza: ${this.formatDate(goal.deadline)}</p>
                                    </div>
                                </div>
                            `;
                        } catch (goalRenderError) {
                            console.warn('Goal render error:', goalRenderError);
                            return '';
                        }
                    }).join('');
                } catch (error) {
                    console.error('Goals render error:', error);
                }
            }

            addExercise() {
                try {
                    const nameInput = document.getElementById('exerciseName');
                    const categorySelect = document.getElementById('exerciseCategory');
                    const muscleGroupInput = document.getElementById('exerciseMuscleGroup');

                    const name = nameInput ? nameInput.value.trim() : '';
                    const category = categorySelect ? categorySelect.value : 'petto';
                    const muscleGroup = muscleGroupInput ? muscleGroupInput.value.trim() : '';

                    if (!name || !muscleGroup) {
                        this.showNotification('Inserisci nome e gruppo muscolare', 'error');
                        return;
                    }

                    // Show loading state
                    const btn = document.getElementById('addExerciseBtn');
                    if (btn) btn.classList.add('btn-loading');

                    setTimeout(() => {
                        const exercise = {
                            id: Date.now(),
                            name,
                            category,
                            muscleGroup
                        };

                        this.exercises.push(exercise);
                        this.saveData();
                        
                        // Clear form
                        if (nameInput) nameInput.value = '';
                        if (muscleGroupInput) muscleGroupInput.value = '';
                        if (categorySelect) categorySelect.value = 'petto';

                        // Remove loading state
                        if (btn) btn.classList.remove('btn-loading');

                        // Re-render
                        this.renderExercises();
                        if (this.currentView === 'dashboard') this.renderDashboard();
                        
                        this.showNotification('Esercizio aggiunto con successo!', 'success');
                    }, 300);
                } catch (error) {
                    console.error('Add exercise error:', error);
                    this.showNotification('Errore durante l\'aggiunta dell\'esercizio', 'error');
                    const btn = document.getElementById('addExerciseBtn');
                    if (btn) btn.classList.remove('btn-loading');
                }
            }

            addWorkout(exerciseId) {
                try {
                    const weightInput = document.getElementById(`weight-${exerciseId}`);
                    const setsInput = document.getElementById(`sets-${exerciseId}`);
                    const repsInput = document.getElementById(`reps-${exerciseId}`);
                    const dateInput = document.getElementById(`date-${exerciseId}`);

                    if (!weightInput || !setsInput || !repsInput || !dateInput) {
                        this.showNotification('Errore nei campi del form', 'error');
                        return;
                    }

                    const weight = parseFloat(weightInput.value);
                    const sets = parseInt(setsInput.value);
                    const reps = parseInt(repsInput.value);
                    const date = dateInput.value;

                    if (!weight || weight <= 0 || !sets || sets <= 0 || !reps || reps <= 0) {
                        this.showNotification('Inserisci valori validi per tutti i campi', 'error');
                        return;
                    }

                    const exercise = this.exercises.find(ex => ex.id === exerciseId);
                    if (!exercise) {
                        this.showNotification('Esercizio non trovato', 'error');
                        return;
                    }

                    const workout = {
                        id: Date.now(),
                        exerciseId,
                        exercise: exercise.name,
                        weight,
                        sets,
                        reps,
                        date
                    };

                    this.workouts.push(workout);
                    this.saveData();

                    // Clear inputs
                    weightInput.value = '';
                    setsInput.value = '';
                    repsInput.value = '';
                    dateInput.value = new Date().toISOString().split('T')[0];

                    // Update current values for goals
                    this.updateGoalProgress(exerciseId, weight);

                    // Re-render
                    if (this.currentView === 'exercises') this.renderExercises();
                    if (this.currentView === 'dashboard') this.renderDashboard();

                    this.showNotification('Carico aggiunto con successo!', 'success');
                } catch (error) {
                    console.error('Add workout error:', error);
                    this.showNotification('Errore durante il salvataggio del carico', 'error');
                }
            }

            addMeasurement() {
                try {
                    const typeSelect = document.getElementById('measurementType');
                    const valueInput = document.getElementById('measurementValue');
                    const dateInput = document.getElementById('measurementDate');

                    const type = typeSelect ? typeSelect.value : '';
                    const value = valueInput ? parseFloat(valueInput.value) : 0;
                    const date = dateInput ? dateInput.value : '';

                    if (!value || !date) {
                        this.showNotification('Compila tutti i campi', 'error');
                        return;
                    }

                    // Show loading state
                    const btn = document.getElementById('addMeasurementBtn');
                    if (btn) btn.classList.add('btn-loading');

                    setTimeout(() => {
                        const measurement = {
                            id: Date.now(),
                            type,
                            value,
                            date
                        };

                        this.bodyMeasurements.push(measurement);
                        this.saveData();

                        // Clear form
                        if (valueInput) valueInput.value = '';
                        if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];

                        // Update current values for body measurement goals
                        this.updateBodyMeasurementGoalProgress(type, value);

                        // Remove loading state
                        if (btn) btn.classList.remove('btn-loading');

                        // Re-render
                        this.renderMeasurements();
                        if (this.currentView === 'dashboard') this.renderDashboard();

                        this.showNotification('Misurazione aggiunta con successo!', 'success');
                    }, 200);
                } catch (error) {
                    console.error('Add measurement error:', error);
                    this.showNotification('Errore durante l\'aggiunta della misurazione', 'error');
                    const btn = document.getElementById('addMeasurementBtn');
                    if (btn) btn.classList.remove('btn-loading');
                }
            }

            addGoal() {
                try {
                    const targetInput = document.getElementById('goalTarget');
                    const typeSelect = document.getElementById('goalType');
                    const valueInput = document.getElementById('goalValue');
                    const deadlineInput = document.getElementById('goalDeadline');

                    const target = targetInput ? targetInput.value.trim() : '';
                    const type = typeSelect ? typeSelect.value : '';
                    const value = valueInput ? parseFloat(valueInput.value) : 0;
                    const deadline = deadlineInput ? deadlineInput.value : '';

                    if (!target || !value || !deadline) {
                        this.showNotification('Compila tutti i campi', 'error');
                        return;
                    }

                    // Show loading state
                    const btn = document.getElementById('addGoalBtn');
                    if (btn) btn.classList.add('btn-loading');

                    setTimeout(() => {
                        const goal = {
                            id: Date.now(),
                            type,
                            target,
                            value,
                            current: 0,
                            deadline
                        };

                        this.goals.push(goal);
                        this.saveData();

                        // Clear form
                        if (targetInput) targetInput.value = '';
                        if (valueInput) valueInput.value = '';
                        if (deadlineInput) deadlineInput.value = new Date().toISOString().split('T')[0];

                        // Remove loading state
                        if (btn) btn.classList.remove('btn-loading');

                        // Re-render
                        this.renderGoals();
                        if (this.currentView === 'dashboard') this.renderDashboard();

                        this.showNotification('Obiettivo aggiunto con successo!', 'success');
                    }, 200);
                } catch (error) {
                    console.error('Add goal error:', error);
                    this.showNotification('Errore durante l\'aggiunta dell\'obiettivo', 'error');
                    const btn = document.getElementById('addGoalBtn');
                    if (btn) btn.classList.remove('btn-loading');
                }
            }

            updateGoalProgress(exerciseId, newWeight) {
                try {
                    const exercise = this.exercises.find(e => e.id === exerciseId);
                    if (!exercise) return;

                    this.goals.forEach(goal => {
                        try {
                            if (goal.type === 'weight' && goal.target && goal.target.toLowerCase().includes(exercise.name.toLowerCase())) {
                                goal.current = Math.max(goal.current || 0, newWeight || 0);
                            }
                        } catch (e) {
                            console.warn('Goal update error for goal:', goal.id);
                        }
                    });
                    
                    this.saveData();
                } catch (error) {
                    console.error('Update goal progress error:', error);
                }
            }

            updateBodyMeasurementGoalProgress(measurementType, newValue) {
                try {
                    this.goals.forEach(goal => {
                        try {
                            if (goal.type === 'body_weight' && measurementType === 'peso') {
                                goal.current = newValue;
                            } else if (goal.type === 'body_measurement' && goal.target && goal.target.toLowerCase().includes(measurementType)) {
                                goal.current = newValue;
                            }
                        } catch (e) {
                            console.warn('Body measurement goal update error for goal:', goal.id);
                        }
                    });
                    
                    this.saveData();
                } catch (error) {
                    console.error('Update body measurement goal progress error:', error);
                }
            }

            calculateGoalProgress(goal) {
                try {
                    if (!goal || typeof goal.current !== 'number' || typeof goal.value !== 'number') {
                        return 0;
                    }
                    
                    if (goal.type === 'body_weight') {
                        // For weight loss goals, calculate differently
                        if (goal.value < goal.current) {
                            const latestWeight = this.bodyMeasurements
                                .filter(m => m.type === 'peso')
                                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                
                            if (latestWeight) {
                                const totalToLose = goal.current - goal.value;
                                const lost = goal.current - latestWeight.value;
                                return Math.max(0, Math.min(100, (lost / totalToLose) * 100));
                            }
                        } else {
                            return Math.min(100, (goal.current / goal.value) * 100);
                        }
                    }
                    return Math.min(100, Math.max(0, (goal.current / goal.value) * 100));
                } catch (error) {
                    console.error('Goal progress calculation error:', error);
                    return 0;
                }
            }

            showDeleteModal(type, id) {
                try {
                    this.deleteTarget = `${type}-${id}`;
                    const modal = document.getElementById('deleteModal');
                    if (modal) modal.classList.remove('hidden');
                } catch (error) {
                    console.error('Show delete modal error:', error);
                }
            }

            showResetModal() {
                try {
                    const modal = document.getElementById('resetModal');
                    if (modal) modal.classList.remove('hidden');
                } catch (error) {
                    console.error('Show reset modal error:', error);
                }
            }

            confirmDelete() {
                try {
                    if (this.deleteTarget) {
                        const [type, id] = this.deleteTarget.split('-');
                        this.handleDelete(type, parseInt(id));
                        this.hideModal('deleteModal');
                        this.deleteTarget = null;
                    }
                } catch (error) {
                    console.error('Confirm delete error:', error);
                }
            }

            confirmReset() {
                try {
                    // Clear all data
                    if (this.isLocalStorageAvailable) {
                        localStorage.removeItem('fittrack_exercises');
                        localStorage.removeItem('fittrack_workouts');
                        localStorage.removeItem('fittrack_measurements');
                        localStorage.removeItem('fittrack_goals');
                    }
                    
                    // Reset arrays
                    this.exercises = [];
                    this.workouts = [];
                    this.bodyMeasurements = [];
                    this.goals = [];

                    // Close modal
                    this.hideModal('resetModal');

                    // Re-render all views
                    this.renderDashboard();
                    this.renderExercises();
                    this.renderMeasurements();
                    this.renderGoals();

                    // Switch to dashboard
                    this.switchView('dashboard');

                    this.showNotification('Applicazione resettata con successo!', 'success');
                } catch (error) {
                    console.error('Reset error:', error);
                    this.showNotification('Errore durante il reset', 'error');
                }
            }

            handleDelete(type, id) {
                try {
                    switch(type) {
                        case 'exercise':
                            this.exercises = this.exercises.filter(ex => ex.id !== id);
                            this.workouts = this.workouts.filter(w => w.exerciseId !== id);
                            break;
                        case 'workout':
                            this.workouts = this.workouts.filter(w => w.id !== id);
                            break;
                        case 'measurement':
                            this.bodyMeasurements = this.bodyMeasurements.filter(m => m.id !== id);
                            break;
                        case 'goal':
                            this.goals = this.goals.filter(g => g.id !== id);
                            break;
                    }

                    this.saveData();

                    // Re-render current view
                    switch(this.currentView) {
                        case 'dashboard':
                            this.renderDashboard();
                            break;
                        case 'exercises':
                            this.renderExercises();
                            break;
                        case 'measurements':
                            this.renderMeasurements();
                            break;
                        case 'goals':
                            this.renderGoals();
                            break;
                    }

                    this.showNotification('Elemento eliminato con successo!', 'success');
                } catch (error) {
                    console.error('Delete error:', error);
                    this.showNotification('Errore durante l\'eliminazione', 'error');
                }
            }

            exportData() {
                try {
                    const data = {
                        exercises: this.exercises,
                        workouts: this.workouts,
                        bodyMeasurements: this.bodyMeasurements,
                        goals: this.goals,
                        exportDate: new Date().toISOString(),
                        version: '2.1'
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `fittrack-backup-${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();

                    this.showNotification('Dati esportati con successo!', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Errore durante l\'esportazione', 'error');
                }
            }

            importData(event) {
                try {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Validate data structure
                            if (!data.exercises || !data.workouts || !data.bodyMeasurements || !data.goals) {
                                throw new Error('Invalid data format');
                            }

                            // Import data
                            this.exercises = Array.isArray(data.exercises) ? data.exercises : [];
                            this.workouts = Array.isArray(data.workouts) ? data.workouts : [];
                            this.bodyMeasurements = Array.isArray(data.bodyMeasurements) ? data.bodyMeasurements : [];
                            this.goals = Array.isArray(data.goals) ? data.goals : [];

                            this.saveData();

                            // Re-render current view
                            switch(this.currentView) {
                                case 'dashboard':
                                    this.renderDashboard();
                                    break;
                                case 'exercises':
                                    this.renderExercises();
                                    break;
                                case 'progress':
                                    this.renderProgress();
                                    break;
                                case 'measurements':
                                    this.renderMeasurements();
                                    break;
                                case 'goals':
                                    this.renderGoals();
                                    break;
                            }

                            this.showNotification('Dati importati con successo!', 'success');
                        } catch (error) {
                            this.showNotification('Errore nell\'importazione dei dati', 'error');
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);

                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    console.error('Import handler error:', error);
                    this.showNotification('Errore durante l\'importazione', 'error');
                }
            }

            showNotification(message, type = 'info') {
                try {
                    // Remove existing notifications
                    const existing = document.querySelectorAll('.notification');
                    existing.forEach(n => {
                        try {
                            n.remove();
                        } catch (e) {
                            // Ignore removal errors
                        }
                    });

                    // Create notification element
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    
                    const icons = {
                        success: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>`,
                        error: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>`,
                        info: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>`
                    };

                    notification.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                ${icons[type] || icons.info}
                            </div>
                            <p class="font-medium">${message || 'Operazione completata'}</p>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Show notification
                    setTimeout(() => {
                        notification.classList.add('show');
                    }, 50);
                    
                    // Hide notification
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            try {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            } catch (e) {
                                // Ignore removal errors
                            }
                        }, 300);
                    }, 3000);
                } catch (error) {
                    console.error('Notification error:', error);
                    // Fallback to simple alert if notification fails
                    alert(message);
                }
            }

            formatDate(dateStr) {
                try {
                    if (!dateStr) return 'Data non valida';
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'Data non valida';
                    
                    return date.toLocaleDateString('it-IT', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (error) {
                    console.error('Date formatting error:', error);
                    return 'Data non valida';
                }
            }
        }

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                window.fitTrackerInstance = new FitTracker();
                window.FitTracker = FitTracker;
                console.log('FitTracker initialized successfully');
            } catch (error) {
                console.error('FitTracker initialization error:', error);
                // Show basic error message
                document.body.innerHTML = `
                    <div class="fixed inset-0 bg-slate-900 flex items-center justify-center">
                        <div class="text-center p-8">
                            <div class="text-6xl mb-4">⚠️</div>
                            <h1 class="text-white text-2xl mb-2">Errore di Inizializzazione</h1>
                            <p class="text-gray-400 mb-4">Si è verificato un errore durante l'avvio dell'applicazione</p>
                            <button onclick="location.reload()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn-fast">
                                Ricarica Pagina
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        // Global error handlers
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            return true;
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });

        // Performance optimization - preload critical resources
        window.addEventListener('load', function() {
            // Preload Chart.js if needed
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded - charts will not be available');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            try {
                if (e.altKey && e.key >= '1' && e.key <= '5') {
                    e.preventDefault();
                    const views = ['dashboard', 'exercises', 'progress', 'measurements', 'goals'];
                    const index = parseInt(e.key) - 1;
                    if (views[index] && window.fitTrackerInstance) {
                        window.fitTrackerInstance.switchView(views[index]);
                    }
                }
            } catch (error) {
                console.error('Keyboard shortcut error:', error);
            }
        });

        // Touch/swipe support for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            try {
                if (!window.fitTrackerInstance) return;
                
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    const views = ['dashboard', 'exercises', 'progress', 'measurements', 'goals'];
                    const currentIndex = views.indexOf(window.fitTrackerInstance.currentView);
                    
                    if (diff > 0 && currentIndex < views.length - 1) {
                        // Swipe left - next view
                        window.fitTrackerInstance.switchView(views[currentIndex + 1]);
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right - previous view
                        window.fitTrackerInstance.switchView(views[currentIndex - 1]);
                    }
                }
            } catch (error) {
                console.error('Swipe handler error:', error);
            }
        }
    </script>
</body>
</html>
