import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, PieChart, Pie, Cell, AreaChart, Area } from 'recharts';
import { Plus, TrendingUp, Target, User, Calendar, Award, Dumbbell, Activity, Settings, Home, BarChart3, Ruler, Bell, Edit3, Trash2, Filter, ChevronRight, Star, AlertTriangle, Save, X, Check, Zap, Flame, TrendingDown, Download, Upload, Search, Calculator, BookOpen, Moon, Sun } from 'lucide-react';

const FitTrackPro = () => {
  const [currentView, setCurrentView] = useState('dashboard');
  const [exercises, setExercises] = useState([]);
  const [workouts, setWorkouts] = useState([]);
  const [bodyMeasurements, setBodyMeasurements] = useState([]);
  const [goals, setGoals] = useState([]);
  const [loading, setLoading] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
  const [darkMode, setDarkMode] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  // Form states - Fixed input bug by using useCallback
  const [newExercise, setNewExercise] = useState({ name: '', category: 'petto', muscleGroup: '' });
  const [newWorkout, setNewWorkout] = useState({ exerciseId: '', exercise: '', weight: '', sets: '', reps: '', date: new Date().toISOString().split('T')[0] });
  const [newMeasurement, setNewMeasurement] = useState({ type: 'peso', value: '', date: new Date().toISOString().split('T')[0] });
  const [newGoal, setNewGoal] = useState({ type: 'exercise', target: '', value: '', deadline: '' });

  const categories = ['petto', 'schiena', 'spalle', 'bicipiti', 'tricipiti', 'gambe', 'addominali', 'cardio'];
  const measurementTypes = ['peso', 'altezza', 'petto', 'vita', 'fianchi', 'braccio_dx', 'braccio_sx', 'coscia_dx', 'coscia_sx'];

  // Sample data initialization
  useEffect(() => {
    if (exercises.length === 0) {
      setLoading(true);
      setTimeout(() => {
        const sampleExercises = [
          { id: 1, name: 'Panca Piana', category: 'petto', muscleGroup: 'Pettorale maggiore' },
          { id: 2, name: 'Squat', category: 'gambe', muscleGroup: 'Quadricipiti' },
          { id: 3, name: 'Deadlift', category: 'schiena', muscleGroup: 'Dorsali' },
          { id: 4, name: 'Military Press', category: 'spalle', muscleGroup: 'Deltoidi' },
          { id: 5, name: 'Curl Bilanciere', category: 'bicipiti', muscleGroup: 'Bicipiti' }
        ];
        setExercises(sampleExercises);

        const sampleWorkouts = [
          { id: 1, exerciseId: 1, exercise: 'Panca Piana', weight: 80, sets: 3, reps: 8, date: '2025-08-15' },
          { id: 2, exerciseId: 1, exercise: 'Panca Piana', weight: 82, sets: 3, reps: 8, date: '2025-08-18' },
          { id: 3, exerciseId: 1, exercise: 'Panca Piana', weight: 85, sets: 3, reps: 7, date: '2025-08-22' },
          { id: 4, exerciseId: 1, exercise: 'Panca Piana', weight: 87, sets: 3, reps: 7, date: '2025-08-25' },
          { id: 5, exerciseId: 1, exercise: 'Panca Piana', weight: 90, sets: 3, reps: 6, date: '2025-08-27' },
          { id: 6, exerciseId: 2, exercise: 'Squat', weight: 100, sets: 4, reps: 6, date: '2025-08-16' },
          { id: 7, exerciseId: 2, exercise: 'Squat', weight: 105, sets: 4, reps: 6, date: '2025-08-20' },
          { id: 8, exerciseId: 2, exercise: 'Squat', weight: 110, sets: 4, reps: 6, date: '2025-08-24' },
          { id: 9, exerciseId: 3, exercise: 'Deadlift', weight: 120, sets: 3, reps: 5, date: '2025-08-17' },
          { id: 10, exerciseId: 3, exercise: 'Deadlift', weight: 125, sets: 3, reps: 5, date: '2025-08-21' },
        ];
        setWorkouts(sampleWorkouts);

        const sampleMeasurements = [
          { id: 1, type: 'peso', value: 75, date: '2025-08-15' },
          { id: 2, type: 'peso', value: 74.5, date: '2025-08-22' },
          { id: 3, type: 'peso', value: 74, date: '2025-08-27' },
          { id: 4, type: 'petto', value: 98, date: '2025-08-15' },
          { id: 5, type: 'petto', value: 99, date: '2025-08-22' },
          { id: 6, type: 'petto', value: 100, date: '2025-08-27' },
          { id: 7, type: 'braccio_dx', value: 35, date: '2025-08-15' },
          { id: 8, type: 'braccio_dx', value: 35.5, date: '2025-08-27' }
        ];
        setBodyMeasurements(sampleMeasurements);

        const sampleGoals = [
          { id: 1, type: 'exercise', target: 'Panca Piana 100kg', value: 100, current: 90, deadline: '2025-12-31', progress: 90 },
          { id: 2, type: 'body', target: 'Peso 70kg', value: 70, current: 74, deadline: '2025-11-30', progress: 25 },
          { id: 3, type: 'exercise', target: 'Squat 130kg', value: 130, current: 110, deadline: '2025-10-31', progress: 85 }
        ];
        setGoals(sampleGoals);
        setLoading(false);
      }, 1000);
    }
  }, [exercises.length]);

  // Data export/import functionality
  const exportData = useCallback(() => {
    const data = {
      exercises,
      workouts,
      bodyMeasurements,
      goals,
      exportDate: new Date().toISOString()
    };
    const dataStr = JSON.stringify(data, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `fittrack-backup-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  }, [exercises, workouts, bodyMeasurements, goals]);

  // Fixed input handlers using useCallback to prevent re-render issues
  const handleExerciseInputChange = useCallback((field, value) => {
    setNewExercise(prev => ({ ...prev, [field]: value }));
  }, []);

  const handleWorkoutInputChange = useCallback((field, value) => {
    setNewWorkout(prev => ({ ...prev, [field]: value }));
  }, []);

  const handleMeasurementInputChange = useCallback((field, value) => {
    setNewMeasurement(prev => ({ ...prev, [field]: value }));
  }, []);

  const handleGoalInputChange = useCallback((field, value) => {
    setNewGoal(prev => ({ ...prev, [field]: value }));
  }, []);

  // Loading Component
  const LoadingSpinner = ({ size = "medium" }) => {
    const sizeClasses = {
      small: "w-4 h-4",
      medium: "w-8 h-8",
      large: "w-12 h-12"
    };

    return (
      <div className={`${sizeClasses[size]} animate-spin`}>
        <div className={`${sizeClasses[size]} border-4 border-blue-200 border-t-blue-600 rounded-full`}></div>
      </div>
    );
  };

  // Enhanced button component
  const ActionButton = ({ onClick, loading, children, variant = "primary", size = "medium", className = "", disabled = false, ...props }) => {
    const baseClasses = "flex items-center justify-center space-x-2 font-semibold rounded-xl transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg";
    
    const variants = {
      primary: "bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white shadow-blue-500/25 hover:shadow-blue-500/40",
      success: "bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white shadow-green-500/25 hover:shadow-green-500/40",
      warning: "bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white shadow-amber-500/25 hover:shadow-amber-500/40",
      danger: "bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white shadow-red-500/25 hover:shadow-red-500/40",
      secondary: "bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white border border-gray-600 hover:border-gray-500 shadow-gray-500/25",
      outline: "bg-transparent border-2 border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white shadow-blue-500/25"
    };

    const sizes = {
      small: "px-3 py-2 text-sm",
      medium: "px-5 py-3",
      large: "px-7 py-4 text-lg"
    };

    return (
      <button
        onClick={onClick}
        disabled={loading || disabled}
        className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className} ${loading || disabled ? 'opacity-50 cursor-not-allowed transform-none' : ''}`}
        {...props}
      >
        {loading ? <LoadingSpinner size="small" /> : children}
      </button>
    );
  };

  // Enhanced card component
  const AnimatedCard = ({ children, className = "", delay = 0, hover = true }) => {
    return (
      <div 
        className={`bg-gray-800/90 backdrop-blur-xl rounded-3xl p-8 border border-gray-700/50 transition-all duration-500 ${
          hover ? 'hover:transform hover:scale-[1.02] hover:shadow-2xl hover:shadow-blue-500/10 hover:border-gray-600/70' : ''
        } animate-fade-in ${className}`}
        style={{ animationDelay: `${delay}ms` }}
      >
        {children}
      </div>
    );
  };

  // Enhanced Input Component to fix typing issues
  const EnhancedInput = React.memo(({ 
    type = "text", 
    placeholder, 
    value, 
    onChange, 
    className = "",
    ...props 
  }) => {
    return (
      <input
        type={type}
        placeholder={placeholder}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className={`bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 placeholder-gray-400 ${className}`}
        {...props}
      />
    );
  });

  // Smart analysis with better logic
  const analyzeProgress = useMemo(() => {
    const recentWorkouts = workouts.filter(w => {
      const workoutDate = new Date(w.date);
      const twoWeeksAgo = new Date();
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
      return workoutDate >= twoWeeksAgo;
    });

    const progressAnalysis = exercises.map(exercise => {
      const exerciseWorkouts = recentWorkouts.filter(w => w.exerciseId === exercise.id);
      if (exerciseWorkouts.length < 2) return null;

      const sorted = exerciseWorkouts.sort((a, b) => new Date(a.date) - new Date(b.date));
      const first = sorted[0];
      const last = sorted[sorted.length - 1];
      
      const weightProgress = ((last.weight - first.weight) / first.weight) * 100;
      const totalGrowth = last.weight - first.weight;
      
      return {
        exercise: exercise.name,
        progress: weightProgress,
        growth: totalGrowth,
        trend: weightProgress > 5 ? 'excellent' : weightProgress > 0 ? 'good' : weightProgress === 0 ? 'stable' : 'declining',
        suggestion: weightProgress < 1 ? 
          'Considera tecniche di intensità come drop set o rest-pause per stimolare nuovi progressi' : 
          weightProgress > 5 ? 
          'Crescita eccellente! Mantieni questo ritmo e considera di aumentare gradualmente il volume' :
          'Buon progresso! Continua con costanza e valuta piccoli incrementi'
      };
    }).filter(Boolean);

    return progressAnalysis;
  }, [exercises, workouts]);

  // CRUD operations
  const handleDelete = async (type, id) => {
    setLoading(true);
    setTimeout(() => {
      if (type === 'exercise') {
        setExercises(exercises.filter(ex => ex.id !== id));
        setWorkouts(workouts.filter(w => w.exerciseId !== id));
      } else if (type === 'workout') {
        setWorkouts(workouts.filter(w => w.id !== id));
      } else if (type === 'measurement') {
        setBodyMeasurements(bodyMeasurements.filter(m => m.id !== id));
      } else if (type === 'goal') {
        setGoals(goals.filter(g => g.id !== id));
      }
      setShowDeleteConfirm(null);
      setLoading(false);
    }, 400);
  };

  // Navigation Component
  const Navigation = () => (
    <div className="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white p-6 border-b border-gray-700/50 backdrop-blur-lg shadow-2xl">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center space-x-4">
            <div className="p-4 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-3xl shadow-xl shadow-blue-500/30">
              <Dumbbell className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">
                FitTrack Pro
              </h1>
              <p className="text-gray-400 text-sm font-medium">Il tuo tracker fitness definitivo</p>
            </div>
          </div>
          
          <div className="flex items-center space-x-4">
            <ActionButton
              onClick={exportData}
              variant="outline"
              size="small"
            >
              <Download className="w-4 h-4" />
              <span>Esporta Dati</span>
            </ActionButton>
          </div>
        </div>
        
        <div className="flex justify-center">
          <div className="flex space-x-2 bg-gray-800/60 rounded-3xl p-2 backdrop-blur-sm border border-gray-700/30">
            {[
              { id: 'dashboard', icon: Home, label: 'Dashboard', color: 'blue' },
              { id: 'exercises', icon: Dumbbell, label: 'Esercizi', color: 'green' },
              { id: 'progress', icon: BarChart3, label: 'Progressi', color: 'purple' },
              { id: 'measurements', icon: Ruler, label: 'Misure', color: 'pink' },
              { id: 'goals', icon: Target, label: 'Obiettivi', color: 'amber' }
            ].map(item => (
              <button
                key={item.id}
                onClick={() => setCurrentView(item.id)}
                className={`flex items-center space-x-3 px-6 py-4 rounded-2xl text-sm font-semibold transition-all duration-300 transform hover:scale-105 ${
                  currentView === item.id 
                    ? `bg-gradient-to-r from-${item.color}-600 to-${item.color}-700 text-white shadow-lg shadow-${item.color}-500/30 scale-105` 
                    : 'hover:bg-gray-700/50 text-gray-300 hover:text-white'
                }`}
              >
                <item.icon className="w-5 h-5" />
                <span className="hidden sm:inline">{item.label}</span>
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  // Completely redesigned Dashboard
  const Dashboard = () => {
    const completedGoals = goals.filter(g => g.progress >= 100).length;
    const activeGoals = goals.length - completedGoals;
    
    // Calculate best improvements in last 30 days
    const bestImprovements = useMemo(() => {
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      return exercises.map(exercise => {
        const exerciseWorkouts = workouts
          .filter(w => w.exerciseId === exercise.id && new Date(w.date) >= thirtyDaysAgo)
          .sort((a, b) => new Date(a.date) - new Date(b.date));
          
        if (exerciseWorkouts.length < 2) return null;
        
        const first = exerciseWorkouts[0];
        const last = exerciseWorkouts[exerciseWorkouts.length - 1];
        const improvement = last.weight - first.weight;
        
        return {
          exercise: exercise.name,
          improvement,
          percentage: ((improvement / first.weight) * 100).toFixed(1),
          from: first.weight,
          to: last.weight
        };
      })
      .filter(item => item && item.improvement > 0)
      .sort((a, b) => b.improvement - a.improvement)
      .slice(0, 3);
    }, [exercises, workouts]);

    // Get latest measurements trends
    const measurementTrends = useMemo(() => {
      return measurementTypes.map(type => {
        const measurements = bodyMeasurements
          .filter(m => m.type === type)
          .sort((a, b) => new Date(b.date) - new Date(a.date));
          
        if (measurements.length < 2) return null;
        
        const latest = measurements[0];
        const previous = measurements[1];
        const change = latest.value - previous.value;
        
        return {
          type: type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()),
          value: latest.value,
          change,
          unit: type === 'peso' ? 'kg' : 'cm',
          trend: change > 0 ? 'up' : change < 0 ? 'down' : 'stable'
        };
      }).filter(Boolean);
    }, [bodyMeasurements]);

    const statsCards = [
      { title: 'Esercizi Attivi', value: exercises.length, icon: Dumbbell, color: 'blue', subtitle: 'Nel tuo repertorio' },
      { title: 'Obiettivi Completati', value: completedGoals, icon: Award, color: 'green', subtitle: 'Traguardi raggiunti' },
      { title: 'Obiettivi Attivi', value: activeGoals, icon: Target, color: 'purple', subtitle: 'In corso' },
      { title: 'Misure Tracciate', value: bodyMeasurements.length, icon: Ruler, color: 'orange', subtitle: 'Registrazioni totali' }
    ];

    if (loading) {
      return (
        <div className="p-6 space-y-6">
          <div className="flex items-center justify-center h-96">
            <div className="text-center space-y-6">
              <LoadingSpinner size="large" />
              <div className="space-y-2">
                <p className="text-white text-xl font-semibold">Caricamento Dashboard...</p>
                <p className="text-gray-400">Preparando i tuoi dati fitness</p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    return (
      <div className="p-6 space-y-8 max-w-7xl mx-auto">
        <div className="text-center space-y-3">
          <h2 className="text-5xl font-bold bg-gradient-to-r from-white via-blue-100 to-white bg-clip-text text-transparent">
            Dashboard
          </h2>
          <p className="text-gray-400 text-lg">Il tuo centro di controllo fitness</p>
        </div>
        
        {/* Enhanced Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
          {statsCards.map((stat, index) => (
            <AnimatedCard key={stat.title} delay={index * 100} className="relative overflow-hidden">
              <div className={`absolute inset-0 bg-gradient-to-br from-${stat.color}-600/10 to-transparent rounded-3xl`}></div>
              <div className="relative">
                <div className="flex items-center justify-between mb-4">
                  <div className={`p-4 bg-gradient-to-r from-${stat.color}-600 to-${stat.color}-700 rounded-2xl shadow-lg shadow-${stat.color}-500/30`}>
                    <stat.icon className="w-7 h-7 text-white" />
                  </div>
                </div>
                <h3 className="text-gray-400 text-sm font-medium mb-2">{stat.title}</h3>
                <p className="text-4xl font-bold text-white mb-1">{stat.value}</p>
                <p className="text-gray-500 text-xs">{stat.subtitle}</p>
              </div>
            </AnimatedCard>
          ))}
        </div>

        {/* Top Improvements */}
        {bestImprovements.length > 0 && (
          <AnimatedCard delay={400}>
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-white flex items-center">
                <Flame className="w-7 h-7 mr-3 text-orange-400" />
                Top Miglioramenti (30gg)
              </h3>
              <div className="flex items-center space-x-2 text-gray-400">
                <TrendingUp className="w-5 h-5" />
                <span className="text-sm">Migliori progressi</span>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {bestImprovements.map((improvement, index) => (
                <div key={index} 
                     className="bg-gradient-to-br from-orange-900/20 to-red-900/10 p-6 rounded-2xl border border-orange-500/20 relative overflow-hidden group hover:border-orange-500/40 transition-all duration-300"
                >
                  <div className="absolute top-2 right-2 text-orange-400 font-bold text-lg">
                    #{index + 1}
                  </div>
                  <div className="space-y-3">
                    <h4 className="text-white font-bold text-lg">{improvement.exercise}</h4>
                    <div className="flex items-center justify-between">
                      <span className="text-gray-400 text-sm">Progresso:</span>
                      <span className="text-orange-400 font-bold">+{improvement.improvement}kg</span>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-gray-400 text-sm">Crescita:</span>
                      <span className="text-green-400 font-bold">+{improvement.percentage}%</span>
                    </div>
                    <div className="pt-2 border-t border-gray-700">
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-gray-500">{improvement.from}kg → {improvement.to}kg</span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </AnimatedCard>
        )}

        {/* Smart Analytics */}
        {analyzeProgress.length > 0 && (
          <AnimatedCard delay={600}>
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-white flex items-center">
                <Zap className="w-7 h-7 mr-3 text-yellow-400" />
                Analisi Intelligente
              </h3>
              <div className="flex items-center space-x-2 text-gray-400">
                <Calculator className="w-5 h-5" />
                <span className="text-sm">Basato su ultimi 14 giorni</span>
              </div>
            </div>
            
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {analyzeProgress.map((analysis, index) => (
                <div key={index} className={`p-6 rounded-2xl border transition-all duration-300 hover:scale-[1.02] ${
                  analysis.trend === 'excellent' ? 'bg-gradient-to-br from-green-900/30 to-green-800/10 border-green-500/30 hover:border-green-500/50' :
                  analysis.trend === 'good' ? 'bg-gradient-to-br from-blue-900/30 to-blue-800/10 border-blue-500/30 hover:border-blue-500/50' :
                  analysis.trend === 'stable' ? 'bg-gradient-to-br from-yellow-900/30 to-yellow-800/10 border-yellow-500/30 hover:border-yellow-500/50' :
                  'bg-gradient-to-br from-red-900/30 to-red-800/10 border-red-500/30 hover:border-red-500/50'
                }`}>
                  <div className="flex items-center justify-between mb-4">
                    <h4 className="text-white font-bold text-lg">{analysis.exercise}</h4>
                    <div className={`flex items-center space-x-2 px-3 py-2 rounded-full text-sm font-bold ${
                      analysis.trend === 'excellent' ? 'bg-green-500/20 text-green-400' :
                      analysis.trend === 'good' ? 'bg-blue-500/20 text-blue-400' :
                      analysis.trend === 'stable' ? 'bg-yellow-500/20 text-yellow-400' :
                      'bg-red-500/20 text-red-400'
                    }`}>
                      {analysis.trend === 'excellent' && <TrendingUp className="w-4 h-4" />}
                      {analysis.trend === 'good' && <TrendingUp className="w-4 h-4" />}
                      {analysis.trend === 'stable' && <Flame className="w-4 h-4" />}
                      {analysis.trend === 'declining' && <TrendingDown className="w-4 h-4" />}
                      <span>{analysis.progress > 0 ? '+' : ''}{analysis.progress.toFixed(1)}%</span>
                    </div>
                  </div>
                  
                  {analysis.growth !== 0 && (
                    <div className="mb-3">
                      <span className={`text-sm font-medium ${analysis.growth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {analysis.growth > 0 ? '+' : ''}{analysis.growth}kg negli ultimi 14 giorni
                      </span>
                    </div>
                  )}
                  
                  <p className="text-gray-300 text-sm leading-relaxed">{analysis.suggestion}</p>
                </div>
              ))}
            </div>
          </AnimatedCard>
        )}

        {/* Body Measurements Overview */}
        {measurementTrends.length > 0 && (
          <AnimatedCard delay={800}>
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-white flex items-center">
                <User className="w-7 h-7 mr-3 text-pink-400" />
                Andamento Corporeo
              </h3>
              <div className="flex items-center space-x-2 text-gray-400">
                <TrendingUp className="w-5 h-5" />
                <span className="text-sm">Ultimi cambiamenti</span>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {measurementTrends.slice(0, 6).map((trend, index) => (
                <div key={index} 
                     className="bg-gray-700/50 p-5 rounded-xl border border-gray-600/30 hover:bg-gray-700 transition-all duration-300"
                >
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-white font-semibold text-sm">{trend.type}</h4>
                    <div className={`flex items-center space-x-1 ${
                      trend.trend === 'up' ? 'text-green-400' :
                      trend.trend === 'down' ? 'text-red-400' :
                      'text-gray-400'
                    }`}>
                      {trend.trend === 'up' && <TrendingUp className="w-4 h-4" />}
                      {trend.trend === 'down' && <TrendingDown className="w-4 h-4" />}
                      {trend.trend === 'stable' && <Flame className="w-4 h-4" />}
                      <span className="text-xs font-medium">
                        {trend.change > 0 ? '+' : ''}{trend.change.toFixed(1)}{trend.unit}
                      </span>
                    </div>
                  </div>
                  <p className="text-pink-400 font-bold text-xl">{trend.value}{trend.unit}</p>
                </div>
              ))}
            </div>
          </AnimatedCard>
        )}
      </div>
    );
  };

  // Enhanced Exercises Management - Removed workout totals and volume
  const ExercisesView = () => {
    const [selectedCategory, setSelectedCategory] = useState('all');

    const filteredExercises = useMemo(() => {
      let filtered = selectedCategory === 'all' 
        ? exercises 
        : exercises.filter(ex => ex.category === selectedCategory);
      
      if (searchTerm) {
        filtered = filtered.filter(ex => 
          ex.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          ex.muscleGroup.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }
      
      return filtered;
    }, [exercises, selectedCategory, searchTerm]);

    return (
      <div className="p-6 space-y-8 max-w-7xl mx-auto">
        <div className="text-center space-y-3">
          <h2 className="text-5xl font-bold bg-gradient-to-r from-white via-green-100 to-white bg-clip-text text-transparent">
            Gestione Esercizi
          </h2>
          <p className="text-gray-400 text-lg">Organizza e monitora i tuoi esercizi</p>
        </div>
        
        {/* Add Exercise Form */}
        <AnimatedCard>
          <div className="flex items-center mb-6">
            <div className="p-4 bg-gradient-to-r from-green-600 to-green-700 rounded-2xl mr-4 shadow-lg shadow-green-500/30">
              <Plus className="w-7 h-7 text-white" />
            </div>
            <h3 className="text-2xl font-bold text-white">Nuovo Esercizio</h3>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <EnhancedInput
              placeholder="Nome esercizio"
              value={newExercise.name}
              onChange={(value) => handleExerciseInputChange('name', value)}
            />
            <select
              className="bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-green-500 focus:outline-none focus:ring-4 focus:ring-green-500/20 transition-all duration-300"
              value={newExercise.category}
              onChange={(e) => handleExerciseInputChange('category', e.target.value)}
            >
              {categories.map(cat => (
                <option key={cat} value={cat}>{cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
              ))}
            </select>
            <EnhancedInput
              placeholder="Gruppo muscolare"
              value={newExercise.muscleGroup}
              onChange={(value) => handleExerciseInputChange('muscleGroup', value)}
            />
          </div>
          
          <ActionButton
            onClick={async () => {
              if (newExercise.name && newExercise.muscleGroup) {
                setLoading(true);
                setTimeout(() => {
                  const exercise = {
                    id: Date.now(),
                    ...newExercise
                  };
                  setExercises([...exercises, exercise]);
                  setNewExercise({ name: '', category: 'petto', muscleGroup: '' });
                  setLoading(false);
                }, 500);
              }
            }}
            loading={loading}
            variant="success"
            disabled={!newExercise.name || !newExercise.muscleGroup}
          >
            <Plus className="w-5 h-5" />
            <span>Aggiungi Esercizio</span>
          </ActionButton>
        </AnimatedCard>

        {/* Search and Filter */}
        <AnimatedCard delay={200}>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="space-y-2">
              <label className="text-white font-semibold flex items-center">
                <Search className="w-5 h-5 mr-2" />
                Cerca Esercizi
              </label>
              <EnhancedInput
                placeholder="Cerca per nome o gruppo muscolare..."
                value={searchTerm}
                onChange={setSearchTerm}
              />
            </div>
            <div className="space-y-2">
              <label className="text-white font-semibold flex items-center">
                <Filter className="w-5 h-5 mr-2" />
                Filtra per Categoria
              </label>
              <select
                className="w-full bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/20 transition-all duration-300"
                value={selectedCategory}
                onChange={(e) => setSelectedCategory(e.target.value)}
              >
                <option value="all">Tutti ({exercises.length})</option>
                {categories.map(category => {
                  const count = exercises.filter(ex => ex.category === category).length;
                  return (
                    <option key={category} value={category}>
                      {category.charAt(0).toUpperCase() + category.slice(1)} ({count})
                    </option>
                  );
                })}
              </select>
            </div>
          </div>
        </AnimatedCard>

        {/* Exercises Grid - Simplified to show only max weight */}
        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
          {filteredExercises.map((exercise, index) => {
            const exerciseWorkouts = workouts.filter(w => w.exerciseId === exercise.id);
            const maxWeight = exerciseWorkouts.length > 0 ? Math.max(...exerciseWorkouts.map(w => w.weight)) : 0;
            const latestWorkout = exerciseWorkouts.length > 0 ? 
              exerciseWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;
            
            return (
              <AnimatedCard key={exercise.id} delay={index * 100} className="relative group">
                {/* Category badge */}
                <div className={`absolute -top-3 -right-3 px-4 py-2 rounded-full text-xs font-bold shadow-lg ${
                  exercise.category === 'petto' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' :
                  exercise.category === 'schiena' ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white' :
                  exercise.category === 'gambe' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white' :
                  exercise.category === 'spalle' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white' :
                  'bg-gradient-to-r from-purple-500 to-purple-600 text-white'
                }`}>
                  {exercise.category}
                </div>

                <div className="flex items-start justify-between mb-6">
                  <div className="flex items-center">
                    <div className="p-4 bg-gradient-to-r from-gray-600 to-gray-700 rounded-2xl mr-4 shadow-lg">
                      <Dumbbell className="w-7 h-7 text-white" />
                    </div>
                    <div>
                      <h4 className="text-white font-bold text-xl">{exercise.name}</h4>
                      <p className="text-gray-400 text-sm">{exercise.muscleGroup}</p>
                    </div>
                  </div>
                  
                  <ActionButton
                    onClick={() => setShowDeleteConfirm(`exercise-${exercise.id}`)}
                    variant="danger"
                    size="small"
                    className="opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    <Trash2 className="w-4 h-4" />
                  </ActionButton>
                </div>
                
                <div className="space-y-4 mb-6">
                  <div className="flex justify-between items-center p-4 bg-gray-700/30 rounded-xl">
                    <span className="text-gray-400 text-sm font-medium">Peso Massimo</span>
                    <span className="text-blue-400 font-bold text-2xl">{maxWeight}kg</span>
                  </div>
                  {latestWorkout && (
                    <div className="flex justify-between items-center p-4 bg-gray-700/30 rounded-xl">
                      <span className="text-gray-400 text-sm font-medium">Ultimo Allenamento</span>
                      <span className="text-green-400 font-semibold">
                        {new Date(latestWorkout.date).toLocaleDateString('it-IT')}
                      </span>
                    </div>
                  )}
                </div>

                {/* Add workout section */}
                <div className="border-t border-gray-700/50 pt-6">
                  <h5 className="text-white font-semibold mb-4 flex items-center">
                    <Plus className="w-5 h-5 mr-2" />
                    Aggiungi Carico
                  </h5>
                  <div className="grid grid-cols-3 gap-3 mb-4">
                    <EnhancedInput
                      type="number"
                      placeholder="Peso"
                      value={newWorkout.exerciseId === exercise.id ? newWorkout.weight : ''}
                      onChange={(value) => {
                        setNewWorkout({
                          ...newWorkout, 
                          exerciseId: exercise.id, 
                          exercise: exercise.name, 
                          weight: value
                        });
                      }}
                      className="text-sm p-3"
                    />
                    <EnhancedInput
                      type="number"
                      placeholder="Serie"
                      value={newWorkout.exerciseId === exercise.id ? newWorkout.sets : ''}
                      onChange={(value) => {
                        setNewWorkout({
                          ...newWorkout, 
                          exerciseId: exercise.id, 
                          exercise: exercise.name, 
                          sets: value
                        });
                      }}
                      className="text-sm p-3"
                    />
                    <EnhancedInput
                      type="number"
                      placeholder="Reps"
                      value={newWorkout.exerciseId === exercise.id ? newWorkout.reps : ''}
                      onChange={(value) => {
                        setNewWorkout({
                          ...newWorkout, 
                          exerciseId: exercise.id, 
                          exercise: exercise.name, 
                          reps: value
                        });
                      }}
                      className="text-sm p-3"
                    />
                  </div>
                  <EnhancedInput
                    type="date"
                    value={newWorkout.exerciseId === exercise.id ? newWorkout.date : new Date().toISOString().split('T')[0]}
                    onChange={(value) => {
                      setNewWorkout({
                        ...newWorkout, 
                        exerciseId: exercise.id, 
                        exercise: exercise.name, 
                        date: value
                      });
                    }}
                    className="w-full mb-4 text-sm p-3"
                  />
                  
                  <ActionButton
                    onClick={async () => {
                      if (newWorkout.exerciseId === exercise.id && newWorkout.weight && newWorkout.sets && newWorkout.reps) {
                        setLoading(true);
                        setTimeout(() => {
                          const workout = {
                            id: Date.now(),
                            exerciseId: exercise.id,
                            exercise: exercise.name,
                            weight: parseInt(newWorkout.weight),
                            sets: parseInt(newWorkout.sets),
                            reps: parseInt(newWorkout.reps),
                            date: newWorkout.date
                          };
                          setWorkouts([...workouts, workout]);
                          setNewWorkout({ exerciseId: '', exercise: '', weight: '', sets: '', reps: '', date: new Date().toISOString().split('T')[0] });
                          setLoading(false);
                        }, 500);
                      }
                    }}
                    loading={loading}
                    variant="success"
                    size="small"
                    className="w-full"
                    disabled={
                      newWorkout.exerciseId !== exercise.id || 
                      !newWorkout.weight || 
                      !newWorkout.sets || 
                      !newWorkout.reps
                    }
                  >
                    <Check className="w-4 h-4" />
                    <span>Salva Carico</span>
                  </ActionButton>
                </div>
              </AnimatedCard>
            );
          })}
        </div>

        {filteredExercises.length === 0 && (
          <AnimatedCard className="text-center py-12">
            <div className="space-y-4">
              <div className="p-6 bg-gray-700/30 rounded-full w-24 h-24 mx-auto flex items-center justify-center">
                <Search className="w-12 h-12 text-gray-400" />
              </div>
              <h3 className="text-xl font-semibold text-gray-300">Nessun esercizio trovato</h3>
              <p className="text-gray-500">
                {searchTerm ? 
                  `Nessun risultato per "${searchTerm}"` : 
                  `Nessun esercizio nella categoria "${selectedCategory}"`
                }
              </p>
            </div>
          </AnimatedCard>
        )}

        {/* Delete Confirmation Modal */}
        {showDeleteConfirm && (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <AnimatedCard className="max-w-md w-full">
              <div className="text-center space-y-6">
                <div className="p-6 bg-red-500/20 rounded-full w-20 h-20 mx-auto flex items-center justify-center">
                  <AlertTriangle className="w-10 h-10 text-red-400" />
                </div>
                <div className="space-y-2">
                  <h3 className="text-2xl font-bold text-white">Conferma Eliminazione</h3>
                  <p className="text-gray-300 leading-relaxed">
                    Sei sicuro di voler eliminare questo elemento? Questa azione non può essere annullata.
                  </p>
                </div>
                <div className="flex space-x-4 pt-4">
                  <ActionButton
                    onClick={() => setShowDeleteConfirm(null)}
                    variant="secondary"
                    className="flex-1"
                  >
                    Annulla
                  </ActionButton>
                  <ActionButton
                    onClick={() => {
                      const [type, id] = showDeleteConfirm.split('-');
                      handleDelete(type, parseInt(id));
                    }}
                    variant="danger"
                    className="flex-1"
                  >
                    Elimina
                  </ActionButton>
                </div>
              </div>
            </AnimatedCard>
          </div>
        )}
      </div>
    );
  };

  // Enhanced Progress Charts
  const ProgressView = () => {
    const [selectedExercise, setSelectedExercise] = useState('');
    const [chartType, setChartType] = useState('weight');
    
    const getExerciseProgress = useCallback((exerciseName) => {
      return workouts
        .filter(w => w.exercise === exerciseName)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map(w => ({
          date: new Date(w.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }),
          peso: w.weight,
          volume: w.weight * w.sets * w.reps,
          oneRM: Math.round(w.weight * (1 + w.reps / 30))
        }));
    }, [workouts]);

    const exerciseOptions = useMemo(() => [...new Set(workouts.map(w => w.exercise))], [workouts]);
    const chartData = useMemo(() => selectedExercise ? getExerciseProgress(selectedExercise) : [], [selectedExercise, getExerciseProgress]);

    return (
      <div className="p-6 space-y-8 max-w-7xl mx-auto">
        <div className="text-center space-y-3">
          <h2 className="text-5xl font-bold bg-gradient-to-r from-white via-purple-100 to-white bg-clip-text text-transparent">
            Analisi Progressi
          </h2>
          <p className="text-gray-400 text-lg">Visualizza i tuoi miglioramenti nel tempo</p>
        </div>
        
        <AnimatedCard>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div className="space-y-3">
              <label className="text-white font-semibold flex items-center text-lg">
                <Filter className="w-5 h-5 mr-2" />
                Seleziona Esercizio
              </label>
              <select
                className="w-full bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-purple-500 focus:outline-none focus:ring-4 focus:ring-purple-500/20 transition-all duration-300"
                value={selectedExercise}
                onChange={(e) => setSelectedExercise(e.target.value)}
              >
                <option value="">Seleziona esercizio</option>
                {exerciseOptions.map(exercise => (
                  <option key={exercise} value={exercise}>{exercise}</option>
                ))}
              </select>
            </div>
            <div className="space-y-3">
              <label className="text-white font-semibold flex items-center text-lg">
                <BarChart3 className="w-5 h-5 mr-2" />
                Tipo di Grafico
              </label>
              <select
                className="w-full bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-purple-500 focus:outline-none focus:ring-4 focus:ring-purple-500/20 transition-all duration-300"
                value={chartType}
                onChange={(e) => setChartType(e.target.value)}
              >
                <option value="weight">Progressione Peso</option>
                <option value="volume">Volume di Allenamento</option>
                <option value="oneRM">1RM Stimato</option>
              </select>
            </div>
          </div>

          {chartData.length > 0 && (
            <div className="bg-gray-800/50 p-8 rounded-3xl border border-gray-700/30">
              <h3 className="text-white font-bold text-2xl mb-6 flex items-center">
                <TrendingUp className="w-6 h-6 mr-3 text-purple-400" />
                {chartType === 'weight' ? 'Progressione Peso' : 
                 chartType === 'volume' ? 'Volume di Allenamento' : '1RM Stimato'}
              </h3>
              <ResponsiveContainer width="100%" height={450}>
                {chartType === 'volume' ? (
                  <BarChart data={chartData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                    <XAxis dataKey="date" stroke="#9CA3AF" />
                    <YAxis stroke="#9CA3AF" />
                    <Tooltip 
                      contentStyle={{ 
                        backgroundColor: '#1F2937', 
                        border: '1px solid #374151', 
                        borderRadius: '16px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.6)'
                      }}
                      labelStyle={{ color: '#F3F4F6' }}
                    />
                    <Bar dataKey="volume" fill="url(#volumeGradient)" radius={[8, 8, 0, 0]} />
                    <defs>
                      <linearGradient id="volumeGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#10B981" />
                        <stop offset="100%" stopColor="#059669" />
                      </linearGradient>
                    </defs>
                  </BarChart>
                ) : (
                  <AreaChart data={chartData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                    <XAxis dataKey="date" stroke="#9CA3AF" />
                    <YAxis stroke="#9CA3AF" />
                    <Tooltip 
                      contentStyle={{ 
                        backgroundColor: '#1F2937', 
                        border: '1px solid #374151', 
                        borderRadius: '16px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.6)'
                      }}
                      labelStyle={{ color: '#F3F4F6' }}
                    />
                    <Area 
                      type="monotone" 
                      dataKey={chartType} 
                      stroke={chartType === 'weight' ? '#3B82F6' : '#8B5CF6'}
                      fill={`url(#${chartType}Gradient)`}
                      strokeWidth={4}
                    />
                    <defs>
                      <linearGradient id="weightGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#3B82F6" stopOpacity={0.4} />
                        <stop offset="100%" stopColor="#3B82F6" stopOpacity={0} />
                      </linearGradient>
                      <linearGradient id="oneRMGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#8B5CF6" stopOpacity={0.4} />
                        <stop offset="100%" stopColor="#8B5CF6" stopOpacity={0} />
                      </linearGradient>
                    </defs>
                  </AreaChart>
                )}
              </ResponsiveContainer>
            </div>
          )}
        </AnimatedCard>

        {/* Workout History for selected exercise */}
        {selectedExercise && (
          <AnimatedCard delay={300}>
            <h3 className="text-2xl font-bold text-white mb-6 flex items-center">
              <Calendar className="w-7 h-7 mr-3 text-purple-400" />
              Storico {selectedExercise}
            </h3>
            <div className="space-y-4 max-h-96 overflow-y-auto">
              {workouts
                .filter(w => w.exercise === selectedExercise)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map((workout, index) => (
                  <div key={workout.id} 
                       className="flex items-center justify-between bg-gray-700/50 p-5 rounded-2xl hover:bg-gray-700 transition-all duration-300 group border border-gray-600/30"
                  >
                    <div className="flex items-center space-x-4">
                      <div className="p-3 bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl group-hover:scale-110 transition-transform shadow-lg">
                        <Dumbbell className="w-6 h-6 text-white" />
                      </div>
                      <div>
                        <p className="text-white font-bold text-lg">{new Date(workout.date).toLocaleDateString('it-IT')}</p>
                        <p className="text-gray-400 text-sm">1RM stimato: {Math.round(workout.weight * (1 + workout.reps / 30))}kg</p>
                      </div>
                    </div>
                    <div className="flex items-center space-x-6">
                      <div className="text-right">
                        <div className="flex items-center space-x-4">
                          <span className="text-blue-400 font-bold text-xl">{workout.weight}kg</span>
                          <span className="text-gray-300 text-lg">{workout.sets} × {workout.reps}</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          Volume: {(workout.weight * workout.sets * workout.reps).toLocaleString()}kg
                        </div>
                      </div>
                      <ActionButton
                        onClick={() => setShowDeleteConfirm(`workout-${workout.id}`)}
                        variant="danger"
                        size="small"
                        className="opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <Trash2 className="w-4 h-4" />
                      </ActionButton>
                    </div>
                  </div>
                ))}
            </div>
          </AnimatedCard>
        )}

        {/* Category Overview */}
        <AnimatedCard delay={400}>
          <h3 className="text-2xl font-bold text-white mb-6 flex items-center">
            <BarChart3 className="w-7 h-7 mr-3 text-purple-400" />
            Panoramica per Categoria
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            {categories.map((category, index) => {
              const categoryExercises = exercises.filter(ex => ex.category === category);
              const categoryWorkouts = workouts.filter(w => 
                categoryExercises.some(ex => ex.name === w.exercise)
              );
              const totalVolume = categoryWorkouts.reduce((sum, w) => sum + (w.weight * w.sets * w.reps), 0);
              const maxWeight = categoryWorkouts.length > 0 ? Math.max(...categoryWorkouts.map(w => w.weight)) : 0;
              
              return (
                <div key={category} 
                     className="bg-gray-700/50 p-6 rounded-2xl border border-gray-600/30 hover:bg-gray-700 transition-all duration-300 hover:scale-105"
                     style={{ animationDelay: `${500 + index * 100}ms` }}
                >
                  <div className="flex items-center mb-4">
                    <div className={`p-3 rounded-xl mr-3 shadow-lg ${
                      category === 'petto' ? 'bg-gradient-to-r from-red-500 to-red-600' :
                      category === 'schiena' ? 'bg-gradient-to-r from-blue-500 to-blue-600' :
                      category === 'gambe' ? 'bg-gradient-to-r from-green-500 to-green-600' :
                      category === 'spalle' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
                      'bg-gradient-to-r from-purple-500 to-purple-600'
                    }`}>
                      <Dumbbell className="w-6 h-6 text-white" />
                    </div>
                    <h4 className="text-white font-bold text-lg capitalize">{category}</h4>
                  </div>
                  
                  <div className="space-y-3">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-400">Esercizi</span>
                      <span className="text-white font-semibold">{categoryExercises.length}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-400">Peso Max</span>
                      <span className="text-blue-400 font-bold">{maxWeight}kg</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-400">Volume totale</span>
                      <span className="text-purple-400 font-bold">{totalVolume.toLocaleString()}kg</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </AnimatedCard>
      </div>
    );
  };

  // Enhanced Body Measurements
  const MeasurementsView = () => {
    const [selectedMeasurement, setSelectedMeasurement] = useState('peso');
    
    const getMeasurementData = useCallback((type) => {
      return bodyMeasurements
        .filter(m => m.type === type)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map(m => ({
          date: new Date(m.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }),
          value: m.value
        }));
    }, [bodyMeasurements]);

    const chartData = useMemo(() => getMeasurementData(selectedMeasurement), [selectedMeasurement, getMeasurementData]);

    return (
      <div className="p-6 space-y-8 max-w-7xl mx-auto">
        <div className="text-center space-y-3">
          <h2 className="text-5xl font-bold bg-gradient-to-r from-white via-pink-100 to-white bg-clip-text text-transparent">
            Misure Corporee
          </h2>
          <p className="text-gray-400 text-lg">Monitora i cambiamenti del tuo corpo</p>
        </div>
        
        {/* Add Measurement */}
        <AnimatedCard>
          <div className="flex items-center mb-6">
            <div className="p-4 bg-gradient-to-r from-pink-600 to-pink-700 rounded-2xl mr-4 shadow-lg shadow-pink-500/30">
              <Ruler className="w-7 h-7 text-white" />
            </div>
            <h3 className="text-2xl font-bold text-white">Nuova Misurazione</h3>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <select
              className="bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-pink-500 focus:outline-none focus:ring-4 focus:ring-pink-500/20 transition-all duration-300"
              value={newMeasurement.type}
              onChange={(e) => handleMeasurementInputChange('type', e.target.value)}
            >
              {measurementTypes.map(type => (
                <option key={type} value={type}>
                  {type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </option>
              ))}
            </select>
            <EnhancedInput
              type="number"
              step="0.1"
              placeholder="Valore"
              value={newMeasurement.value}
              onChange={(value) => handleMeasurementInputChange('value', value)}
            />
            <EnhancedInput
              type="date"
              value={newMeasurement.date}
              onChange={(value) => handleMeasurementInputChange('date', value)}
            />
          </div>
          
          <ActionButton
            onClick={async () => {
              if (newMeasurement.value) {
                setLoading(true);
                setTimeout(() => {
                  const measurement = {
                    id: Date.now(),
                    type: newMeasurement.type,
                    value: parseFloat(newMeasurement.value),
                    date: newMeasurement.date
                  };
                  setBodyMeasurements([...bodyMeasurements, measurement]);
                  setNewMeasurement({ type: 'peso', value: '', date: new Date().toISOString().split('T')[0] });
                  setLoading(false);
                }, 500);
              }
            }}
            loading={loading}
            variant="warning"
            disabled={!newMeasurement.value}
          >
            <Plus className="w-5 h-5" />
            <span>Aggiungi Misurazione</span>
          </ActionButton>
        </AnimatedCard>

        {/* Measurements Chart */}
        <AnimatedCard delay={200}>
          <div className="flex items-center space-x-4 mb-8">
            <Filter className="w-6 h-6 text-gray-400" />
            <select
              className="bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-pink-500 focus:outline-none focus:ring-4 focus:ring-pink-500/20 transition-all duration-300 text-lg font-semibold"
              value={selectedMeasurement}
              onChange={(e) => setSelectedMeasurement(e.target.value)}
            >
              {measurementTypes.map(type => (
                <option key={type} value={type}>
                  {type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </option>
              ))}
            </select>
          </div>

          {chartData.length > 0 && (
            <div className="bg-gray-800/50 p-8 rounded-3xl border border-gray-700/30">
              <h3 className="text-white font-bold text-2xl mb-6 flex items-center">
                <TrendingUp className="w-6 h-6 mr-3 text-pink-400" />
                Andamento {selectedMeasurement.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
              </h3>
              <ResponsiveContainer width="100%" height={400}>
                <AreaChart data={chartData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                  <XAxis dataKey="date" stroke="#9CA3AF" />
                  <YAxis stroke="#9CA3AF" />
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: '#1F2937', 
                      border: '1px solid #374151', 
                      borderRadius: '16px',
                      boxShadow: '0 20px 40px rgba(0,0,0,0.6)'
                    }}
                    labelStyle={{ color: '#F3F4F6' }}
                  />
                  <Area 
                    type="monotone" 
                    dataKey="value" 
                    stroke="#EC4899" 
                    fill="url(#measurementGradient)"
                    strokeWidth={4}
                  />
                  <defs>
                    <linearGradient id="measurementGradient" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stopColor="#EC4899" stopOpacity={0.4} />
                      <stop offset="100%" stopColor="#EC4899" stopOpacity={0} />
                    </linearGradient>
                  </defs>
                </AreaChart>
              </ResponsiveContainer>
            </div>
          )}
        </AnimatedCard>

        {/* Measurements Summary */}
        <AnimatedCard delay={300}>
          <h3 className="text-2xl font-bold text-white mb-6 flex items-center">
            <User className="w-7 h-7 mr-3 text-pink-400" />
            Riepilogo Misure
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            {measurementTypes.map((type, index) => {
              const typeMeasurements = bodyMeasurements.filter(m => m.type === type);
              const sorted = typeMeasurements.sort((a, b) => new Date(b.date) - new Date(a.date));
              const latest = sorted[0];
              const previous = sorted[1];
              const change = latest && previous ? latest.value - previous.value : 0;
              
              return (
                <div key={type} 
                     className="bg-gray-700/50 p-6 rounded-2xl border border-gray-600/30 hover:bg-gray-700 transition-all duration-300 group relative hover:scale-105"
                     style={{ animationDelay: `${400 + index * 50}ms` }}
                >
                  <div className="flex items-center justify-between mb-4">
                    <h4 className="text-white font-bold text-lg">
                      {type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </h4>
                    {latest && (
                      <ActionButton
                        onClick={() => setShowDeleteConfirm(`measurement-${latest.id}`)}
                        variant="danger"
                        size="small"
                        className="opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <Trash2 className="w-3 h-3" />
                      </ActionButton>
                    )}
                  </div>
                  
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <span className="text-3xl font-bold text-pink-400">
                        {latest ? `${latest.value}${type === 'peso' ? 'kg' : 'cm'}` : 'N/A'}
                      </span>
                      {change !== 0 && (
                        <div className={`flex items-center space-x-1 px-3 py-1 rounded-full text-xs font-bold ${
                          change > 0 ? 'bg-green-900/50 text-green-400 border border-green-500/30' : 'bg-red-900/50 text-red-400 border border-red-500/30'
                        }`}>
                          {change > 0 ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}
                          <span>{change > 0 ? '+' : ''}{change.toFixed(1)}</span>
                        </div>
                      )}
                    </div>
                    <p className="text-gray-400 text-sm">
                      {latest ? `Ultimo: ${new Date(latest.date).toLocaleDateString('it-IT')}` : 'Nessun dato disponibile'}
                    </p>
                    <p className="text-gray-500 text-xs">
                      {typeMeasurements.length} misurazione{typeMeasurements.length !== 1 ? 'i' : 'e'}
                    </p>
                  </div>
                </div>
              );
            })}
          </div>
        </AnimatedCard>
      </div>
    );
  };

  // Enhanced Goals Management
  const GoalsView = () => (
    <div className="p-6 space-y-8 max-w-7xl mx-auto">
      <div className="text-center space-y-3">
        <h2 className="text-5xl font-bold bg-gradient-to-r from-white via-amber-100 to-white bg-clip-text text-transparent">
          Obiettivi
        </h2>
        <p className="text-gray-400 text-lg">Definisci e raggiungi i tuoi traguardi</p>
      </div>
      
      {/* Add Goal */}
      <AnimatedCard>
        <div className="flex items-center mb-6">
          <div className="p-4 bg-gradient-to-r from-amber-600 to-amber-700 rounded-2xl mr-4 shadow-lg shadow-amber-500/30">
            <Target className="w-7 h-7 text-white" />
          </div>
          <h3 className="text-2xl font-bold text-white">Nuovo Obiettivo</h3>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <select
            className="bg-gray-700/50 text-white p-4 rounded-xl border border-gray-600/50 focus:border-amber-500 focus:outline-none focus:ring-4 focus:ring-amber-500/20 transition-all duration-300"
            value={newGoal.type}
            onChange={(e) => handleGoalInputChange('type', e.target.value)}
          >
            <option value="exercise">Esercizio</option>
            <option value="body">Corpo</option>
          </select>
          <EnhancedInput
            placeholder="Descrizione obiettivo"
            value={newGoal.target}
            onChange={(value) => handleGoalInputChange('target', value)}
          />
          <EnhancedInput
            type="number"
            placeholder="Valore target"
            value={newGoal.value}
            onChange={(value) => handleGoalInputChange('value', value)}
          />
          <EnhancedInput
            type="date"
            value={newGoal.deadline}
            onChange={(value) => handleGoalInputChange('deadline', value)}
          />
        </div>
        
        <ActionButton
          onClick={async () => {
            if (newGoal.target && newGoal.value && newGoal.deadline) {
              setLoading(true);
              setTimeout(() => {
                const goal = {
                  id: Date.now(),
                  ...newGoal,
                  value: parseFloat(newGoal.value),
                  current: 0,
                  progress: 0
                };
                setGoals([...goals, goal]);
                setNewGoal({ type: 'exercise', target: '', value: '', deadline: '' });
                setLoading(false);
              }, 500);
            }
          }}
          loading={loading}
          variant="warning"
          disabled={!newGoal.target || !newGoal.value || !newGoal.deadline}
        >
          <Target className="w-5 h-5" />
          <span>Aggiungi Obiettivo</span>
        </ActionButton>
      </AnimatedCard>

      {/* Goals List */}
      <div className="space-y-6">
        {goals.map((goal, index) => {
          const progressPercentage = goal.current > 0 ? (goal.current / goal.value) * 100 : goal.progress;
          const isCompleted = progressPercentage >= 100;
          const deadline = new Date(goal.deadline);
          const today = new Date();
          const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
          
          return (
            <AnimatedCard key={goal.id} delay={index * 150} className="relative group">
              {isCompleted && (
                <div className="absolute -top-3 -right-3 p-3 bg-gradient-to-r from-green-600 to-green-700 rounded-full shadow-xl shadow-green-500/40">
                  <Star className="w-6 h-6 text-white" />
                </div>
              )}
              
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center space-x-4">
                  <div className={`p-4 rounded-2xl shadow-xl ${
                    goal.type === 'exercise' 
                      ? 'bg-gradient-to-r from-blue-600 to-blue-700 shadow-blue-500/30' 
                      : 'bg-gradient-to-r from-green-600 to-green-700 shadow-green-500/30'
                  }`}>
                    {goal.type === 'exercise' ? 
                      <Dumbbell className="w-7 h-7 text-white" /> : 
                      <User className="w-7 h-7 text-white" />
                    }
                  </div>
                  <div>
                    <h3 className="text-white font-bold text-2xl">{goal.target}</h3>
                    <div className="flex items-center space-x-4 mt-2">
                      <p className="text-gray-400">
                        Scadenza: {deadline.toLocaleDateString('it-IT')}
                      </p>
                      <div className={`px-3 py-1 rounded-full text-xs font-bold ${
                        daysLeft > 30 ? 'bg-green-900/50 text-green-400 border border-green-500/30' :
                        daysLeft > 7 ? 'bg-yellow-900/50 text-yellow-400 border border-yellow-500/30' :
                        daysLeft > 0 ? 'bg-orange-900/50 text-orange-400 border border-orange-500/30' :
                        'bg-red-900/50 text-red-400 border border-red-500/30'
                      }`}>
                        {daysLeft > 0 ? `${daysLeft} giorni rimasti` : 'Scaduto'}
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="flex items-center space-x-4">
                  <div className="text-right">
                    <p className="text-white font-bold text-3xl">{progressPercentage.toFixed(1)}%</p>
                    <p className="text-gray-300">{goal.current} / {goal.value}</p>
                  </div>
                  <ActionButton
                    onClick={() => setShowDeleteConfirm(`goal-${goal.id}`)}
                    variant="danger"
                    size="small"
                    className="opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    <Trash2 className="w-4 h-4" />
                  </ActionButton>
                </div>
              </div>
              
              {/* Enhanced Progress Bar */}
              <div className="relative mb-4">
                <div className="w-full bg-gray-700 rounded-full h-5 overflow-hidden shadow-inner">
                  <div 
                    className={`h-full rounded-full transition-all duration-1000 ease-out relative ${
                      isCompleted ? 'bg-gradient-to-r from-green-500 via-green-400 to-green-600 shadow-lg shadow-green-500/40' : 
                      progressPercentage > 75 ? 'bg-gradient-to-r from-yellow-500 via-yellow-400 to-orange-500 shadow-lg shadow-yellow-500/40' : 
                      'bg-gradient-to-r from-blue-500 via-blue-400 to-purple-500 shadow-lg shadow-blue-500/40'
                    }`}
                    style={{ width: `${Math.min(progressPercentage, 100)}%` }}
                  >
                    <div className="absolute inset-0 bg-gradient-to-t from-white/20 to-transparent rounded-full"></div>
                    <div className="absolute inset-0 animate-pulse bg-gradient-to-r from-transparent via-white/10 to-transparent rounded-full"></div>
                  </div>
                </div>
              </div>
              
              {isCompleted && (
                <div className="flex items-center justify-center bg-gradient-to-r from-green-900/40 to-green-800/20 rounded-2xl p-6 border-2 border-green-500/30">
                  <Star className="w-6 h-6 mr-3 text-green-400" />
                  <span className="text-green-400 font-bold text-lg">🎉 Obiettivo completato! Complimenti! 🎉</span>
                </div>
              )}
            </AnimatedCard>
          );
        })}
      </div>
    </div>
  );

  // Main Render
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
      <style jsx>{`
        @keyframes fade-in {
          from {
            opacity: 0;
            transform: translateY(30px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fade-in {
          animation: fade-in 0.8s ease-out forwards;
        }
      `}</style>
      
      <Navigation />
      <div>
        {currentView === 'dashboard' && <Dashboard />}
        {currentView === 'exercises' && <ExercisesView />}
        {currentView === 'progress' && <ProgressView />}
        {currentView === 'measurements' && <MeasurementsView />}
        {currentView === 'goals' && <GoalsView />}
      </div>

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-50 p-4">
          <AnimatedCard className="max-w-lg w-full">
            <div className="text-center space-y-6">
              <div className="p-6 bg-red-500/20 rounded-full w-24 h-24 mx-auto flex items-center justify-center">
                <AlertTriangle className="w-12 h-12 text-red-400" />
              </div>
              <div className="space-y-3">
                <h3 className="text-3xl font-bold text-white">Conferma Eliminazione</h3>
                <p className="text-gray-300 text-lg leading-relaxed">
                  Sei sicuro di voler eliminare questo elemento? Questa azione non può essere annullata e tutti i dati associati verranno persi.
                </p>
              </div>
              <div className="flex space-x-4 pt-6">
                <ActionButton
                  onClick={() => setShowDeleteConfirm(null)}
                  variant="secondary"
                  className="flex-1"
                  size="large"
                >
                  Annulla
                </ActionButton>
                <ActionButton
                  onClick={() => {
                    const [type, id] = showDeleteConfirm.split('-');
                    handleDelete(type, parseInt(id));
                  }}
                  variant="danger"
                  className="flex-1"
                  size="large"
                >
                  Elimina Definitivamente
                </ActionButton>
              </div>
            </div>
          </AnimatedCard>
        </div>
      )}
    </div>
  );
};

export default FitTrackPro;
